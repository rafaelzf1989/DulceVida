<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dulce Vida - Tienda</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="icon" type="image/png" href="https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/favicon.png">
  <style>


    
  </style>
</head>
<body>
<header>
  <div class="cabecera-wrap">
    <img id="cabeceraImg" alt="Dulce Vida" />
  </div>
</header>
<div class="marquesina"><div class="scroll" id="marquesinaScroll"></div></div>
<main>
    <div id="errorMsg"></div>
  <section id="productos" class="productos-grid" aria-label="Lista de productos"></section>
  <section id="carritoBox" style="margin-top:20px;">
    <h2>Carrito 🛒</h2>
    <div id="listaCarrito"></div>
    <div class="carrito-totals-row"><label>Subtotal:</label><span id="subtotalCarrito">0</span> CUP</div>
    <div class="carrito-totals-row"><label>Envío:</label><span id="envioCarrito">0</span> CUP</div>
    <div class="carrito-total-row"><label>TOTAL:</label><span class="carrito-total-valor" id="totalFinalBox">0 CUP</span></div>
    <div style="text-align:right;"><button onclick="vaciarCarrito()" style="background:#e74c3c;padding:6px 19px;font-size:.98em;border-radius:7px;">Vaciar carrito</button></div>
  </section>
  <section id="cliente" aria-label="Formulario de datos del cliente">
    <h3>📝 Datos del Cliente</h3>
    <form id="clienteForm" autocomplete="off" onsubmit="return false;">
      <label>Código país:</label>
      <select id="codigoPais" required>
        <option value="53" selected>🇨🇺 +53 Cuba</option>
        <option value="1">🇺🇸 +1 USA</option>
        <option value="34">🇪🇸 +34 España</option>
        <option value="52">🇲🇽 +52 México</option>
        <option value="55">🇧🇷 +55 Brasil</option>
        <option value="507">🇵🇦 +507 Panamá</option>
        <option value="58">🇻🇪 +58 Venezuela</option>
        <option value="54">🇦🇷 +54 Argentina</option>
        <option value="57">🇨🇴 +57 Colombia</option>
      </select>
      <label>Teléfono:</label>
      <input type="tel" id="telefono" required maxlength="15" autocomplete="tel" placeholder="Ej: 58707434" pattern="[0-9]+" />
      <label>Nombre completo:</label>
      <input type="text" id="nombre" required maxlength="60" autocomplete="name" placeholder="Ej: Ana Pérez" />
      <label>¿Desea entrega a domicilio?</label>
      <select id="entrega" required onchange="mostrarDireccion()"><option value="no" selected>Retiro en tienda</option><option value="si">Sí, entrega a domicilio</option></select>
      <div id="direccionEntrega" style="display:none;">
        <label>Dirección:</label>
        <input type="text" id="direccion" maxlength="100" placeholder="Ej: Calle 1ra #100 entre 2 y 4" />
        <label>Reparto:</label>
        <select id="reparto"></select>
      </div>
      <label>Fecha y hora de entrega:</label>
      <input type="datetime-local" id="fechaEntrega" required />
      <label>Especificaciones del pedido:</label>
      <textarea id="especificaciones" maxlength="300" placeholder="¿Quieres algún detalle especial, dedicatoria, etc.?"></textarea>
      <button id="btnEnviar" type="button" onclick="mostrarResumenConfirmacion()" style="display:flex;align-items:center;gap:8px;">
        <img src="https://file.garden/aEX2yhToiQk-s_Qq/IMG_COM_202506261242078500.png" alt="Icono WhatsApp" style="width:20px;height:20px;object-fit:contain;" />
        Enviar por WhatsApp
      </button>
    </form>
    <p id="mensajeCompra"></p>
  </section>
</main>
<div id="carritoFlotante" onclick="document.getElementById('carritoBox').scrollIntoView({behavior:'smooth'});" aria-label="Ver carrito" tabindex="0" style="display:none;">🛒 <span id="contadorCarrito">0</span></div>
<script>
const endpoint = "https://script.google.com/macros/s/AKfycbxnYsciq5EhfzgcgcF2FnyGECGarxqmF7zdDI0R9bizekqvB48W0RdBA4zZ0EGkDlWt/exec?func=catalogo";
const configEndpoint = "https://script.google.com/macros/s/AKfycbxnYsciq5EhfzgcgcF2FnyGECGarxqmF7zdDI0R9bizekqvB48W0RdBA4zZ0EGkDlWt/exec?func=config";
let productosData = [];
let carrito = [];
let cantidadesPorProducto = {};
let rellenosPorProducto = {};
let repartosConfig = [];
let repartosPrecios = {};
let velocidadMarquesina = 18;
let envioActual = 0;

// Configuración y cabecera
function cargarConfiguraciones() {
  fetch(configEndpoint).then(r=>r.json()).then(config=>{
    // DUPLICA el texto y añade espacio entre ellos para el bucle
    let texto = config.anuncio || '¡Bienvenido!';
    document.getElementById('marquesinaScroll').innerHTML = texto + "&nbsp;&nbsp;&nbsp;&nbsp;" + texto;
    velocidadMarquesina = config.velocidad || 18;
    repartosConfig = config.repartos || [];
    repartosPrecios = config.repartosPrecios || {};
    actualizarRepartos();
    setMarquesinaSpeed();
    if(config.cabeceraImg) {
      document.getElementById('cabeceraImg').src = config.cabeceraImg;
    }
  }).catch(()=>{
    let texto = "¡Bienvenido!";
    document.getElementById('marquesinaScroll').innerHTML = texto + "&nbsp;&nbsp;&nbsp;&nbsp;" + texto;
    setMarquesinaSpeed();
  });
}
function setMarquesinaSpeed() {
  const el = document.querySelector('.marquesina .scroll');
  if(el) {
    el.style.animation = `scroll-lr ${velocidadMarquesina}s linear infinite`;
    el.style.webkitAnimation = `scroll-lr ${velocidadMarquesina}s linear infinite`;
  }
}
function actualizarRepartos() {
  const select = document.getElementById('reparto');
  select.innerHTML = '<option value="">Selecciona reparto</option>';
  repartosConfig.forEach(r=>{
    select.innerHTML += `<option value="${r}">${r}</option>`;
  });
}
cargarConfiguraciones();

// -----AJUSTAR CABECERA-----
// window.addEventListener('resize', ajustarCabeceraImg);
// window.addEventListener('DOMContentLoaded', ajustarCabeceraImg);
// function ajustarCabeceraImg() {
//   let img = document.getElementById('cabeceraImg');
//   img.style.width = "330px";
//   img.style.maxWidth = "95vw";
//   img.style.height = "110px";
//   if(window.innerWidth < 500) {
//     img.style.width = "99vw";
//     img.style.height = "70px";
//   }
// }

// Productos
function mostrarError(msg) {
  document.getElementById('errorMsg').innerHTML = `<div>${msg}</div><button id="tryAgain" onclick="window.location.reload()">Reintentar</button>`;
  document.getElementById('errorMsg').style.display = 'block';
  document.getElementById('productos').style.display = 'none';
  document.getElementById('carritoBox').style.display = 'none';
  document.getElementById('cliente').style.display = 'none';
}
function ocultarError() {
  document.getElementById('errorMsg').style.display = 'none';
  document.getElementById('productos').style.display = '';
  document.getElementById('carritoBox').style.display = '';
  document.getElementById('cliente').style.display = '';
}
function cargarProductos() {
  fetch(endpoint).then(r=>{
    if(!r.ok) throw new Error('Respuesta HTTP no válida');
    return r.json();
  }).then(datos=>{
    productosData = datos;
    datos.forEach((prod, idx)=>{
      cantidadesPorProducto[idx]=0;
      rellenosPorProducto[idx]=prod.Rellenos.map(()=>0);
    });
    ocultarError();
    renderProductos(); actualizarCarrito();
  }).catch(err=>{
    mostrarError("No se pudieron cargar los productos desde la hoja de Google Sheets.<br><small>Error: "+err.message+"</small>");
  });
}
cargarProductos();

function renderProductos() {
  const cont = document.getElementById('productos');
  cont.innerHTML = '';
  productosData.forEach((p, idx) => {
    let estadoTxt = p.Estado||"";
    let agotado = (estadoTxt.trim().toLowerCase() === "agotado");
    let rellenosHTML = '';
    if (p.Rellenos && p.Rellenos.length>0) {
      rellenosHTML = `<div class="rellenos-lista">`+
        p.Rellenos.map((r, ridx) =>
          `<div class="relleno-row">
            <span class="relleno-nombre">${r}</span>
            <button class="relleno-btn" onclick="cambiarRelleno(${idx},${ridx},-1)" ${agotado?'disabled':''}>−</button>
            <span class="relleno-cant" id="rcant${idx}_${ridx}">${rellenosPorProducto[idx][ridx]}</span>
            <button class="relleno-btn" onclick="cambiarRelleno(${idx},${ridx},1)" ${agotado?'disabled':''}>+</button>
          </div>`).join('')+
        `</div>`;
    }
    cont.innerHTML += `
    <div class="producto-card${agotado?' agotado':''}">
      ${agotado?`<div class="agotado-marca">AGOTADO</div>`:""}
      ${estadoTxt? `<div class="producto-estado${agotado?' agotado':''}">${estadoTxt}</div>`:''}
      <img src="${p.Imagen||''}" alt="${p.Nombre}" onclick="mostrarImagenCompleta('${encodeURIComponent(p.Imagen||'')}')">
      <div class="producto-nombre">${p.Nombre}</div>
      <div class="producto-precio">${p.Precio} CUP</div>
      <div class="producto-desc">${p.Descripción||''}</div>
      <div class="cantidad-row">
        <span class="cantidad-nombre"></span>
        <button class="cantidad-btn" onclick="cambiarCantidad(${idx},-1)" ${agotado?'disabled':''}>−</button>
        <span class="cantidad-cant" id="cant${idx}">${cantidadesPorProducto[idx]}</span>
        <button class="cantidad-btn" onclick="cambiarCantidad(${idx},1)" ${agotado?'disabled':''}>+</button>
      </div>
      ${rellenosHTML}
      <button class="producto-agregar" onclick="agregarAlCarrito(${idx})" ${agotado?'disabled':''}>Agregar al Carrito</button>
    </div>
    `;
  });
}
function mostrarImagenCompleta(url) {
  url = decodeURIComponent(url);
  let modal = document.createElement('div');
  modal.id = 'imgModal';
  modal.innerHTML = `<img src="${url}" onclick="document.body.removeChild(document.getElementById('imgModal'))" alt="Imagen producto" />`;
  modal.onclick = ()=>document.body.removeChild(modal);
  document.body.appendChild(modal);
}
function cambiarCantidad(idx, delta) {
  cantidadesPorProducto[idx] = Math.max(0, (cantidadesPorProducto[idx]||0) + delta);
  document.getElementById('cant'+idx).textContent = cantidadesPorProducto[idx];
}
function cambiarRelleno(idx, ridx, delta) {
  rellenosPorProducto[idx][ridx] = Math.max(0, (rellenosPorProducto[idx][ridx]||0) + delta);
  document.getElementById('rcant'+idx+"_"+ridx).textContent = rellenosPorProducto[idx][ridx];
}
function agregarAlCarrito(idx) {
  let cantidad = cantidadesPorProducto[idx]||0;
  if (cantidad<1) { mostrarToast('Selecciona al menos una unidad.'); return; }
  let prod = productosData[idx];
  let rellenos = [];
  if (prod.Rellenos && prod.Rellenos.length>0) {
    rellenos = prod.Rellenos.map((r, ridx) =>
      rellenosPorProducto[idx][ridx]>0
        ? `${r} x${rellenosPorProducto[idx][ridx]}`
        : null
    ).filter(Boolean);
  }
  carrito.push({
    idx,
    nombre: prod.Nombre,
    precio: prod.Precio,
    cantidad,
    rellenos: rellenos.length ? rellenos.join(', ') : ""
  });
  cantidadesPorProducto[idx]=0;
  rellenosPorProducto[idx]=prod.Rellenos.map(()=>0);
  renderProductos(); actualizarCarrito();
  mostrarToast('Producto agregado al carrito');
  document.getElementById('carritoFlotante').style.display = carrito.length ? "flex" : "none";
}
function actualizarCarrito() {
  const lista = document.getElementById('listaCarrito');
  lista.innerHTML = '';
  let subtotal = 0;
  if (carrito.length === 0) {
    lista.innerHTML = `<div class="empty-cart">El carrito está vacío. Añade productos para continuar.</div>`;
  } else {
    carrito.forEach((item, i) => {
      subtotal += item.precio * item.cantidad;
      lista.innerHTML += `
        <div class="carrito-item">
          <img src="${productosData[item.idx].Imagen||''}" class="carrito-img" alt="${item.nombre}">
          <span style="min-width:90px;flex:1;">${item.nombre}</span>
          <div class="carrito-cant">${item.cantidad}</div>
          <button class="carrito-btn" onclick="cambiarCantidadCarrito(${i},-1)">−</button>
          <button class="carrito-btn" onclick="cambiarCantidadCarrito(${i},1)">+</button>
          <span style="min-width:65px;">${item.precio * item.cantidad} CUP</span>
          <button onclick="quitarDelCarrito(${i})" aria-label="Quitar">❌</button>
          ${item.rellenos?`<div style="font-size:.92em;color:#231d66;">(${item.rellenos})</div>`:""}
        </div>
      `;
    });
  }
  let envio = calcularEnvio();
  envioActual = envio;
  document.getElementById('subtotalCarrito').textContent = subtotal;
  document.getElementById('envioCarrito').textContent = envio;
  document.getElementById('totalFinalBox').textContent = (subtotal + envio) + " CUP";
  document.getElementById('contadorCarrito').textContent = carrito.reduce((acc, i) => acc + i.cantidad, 0);
}
function calcularEnvio() {
  let entrega = document.getElementById('entrega')?.value;
  if (entrega === "si") {
    let reparto = document.getElementById('reparto')?.value;
    if (reparto && repartosPrecios[reparto]) return repartosPrecios[reparto];
  }
  return 0;
}
function cambiarCantidadCarrito(idx, delta) {
  carrito[idx].cantidad += delta;
  if (carrito[idx].cantidad < 1) quitarDelCarrito(idx);
  actualizarCarrito();
}
function quitarDelCarrito(idx) {
  carrito.splice(idx, 1);
  actualizarCarrito();
  document.getElementById('carritoFlotante').style.display = carrito.length ? "flex" : "none";
}
function vaciarCarrito() {
  carrito = [];
  actualizarCarrito();
  document.getElementById('carritoFlotante').style.display = "none";
}
function mostrarToast(msg) {
  let toast = document.createElement('div');
  toast.style.position = 'fixed';
  toast.style.bottom = '35px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.background = '#3b2eae';
  toast.style.color = '#fff';
  toast.style.padding = '12px 34px';
  toast.style.fontSize = '1em';
  toast.style.borderRadius = '12px';
  toast.style.boxShadow = '0 2px 10px #1116';
  toast.style.zIndex = '9000';
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(()=>{ toast.style.opacity = "0"; }, 1500);
  setTimeout(()=>{ if (toast.parentNode) toast.parentNode.removeChild(toast); }, 1900);
}
function mostrarDireccion() {
  let entrega = document.getElementById('entrega').value;
  document.getElementById('direccionEntrega').style.display = (entrega === "si" ? "block" : "none");
  actualizarCarrito();
}
function mostrarResumenConfirmacion() {
  if (carrito.length === 0) { mostrarToast('El carrito está vacío.'); return; }
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const codigoPais = document.getElementById('codigoPais').value.trim();
  const entrega = document.getElementById('entrega').value;
  const direccion = entrega === 'si' ? document.getElementById('direccion').value.trim() : '';
  const reparto = entrega === 'si' ? document.getElementById('reparto').value.trim() : '';
  const fechaEntrega = document.getElementById('fechaEntrega').value;
  const especificaciones = document.getElementById('especificaciones').value.trim();
  if (!nombre) { mostrarToast('Debes ingresar tu nombre.'); return; }
  if (!telefono.match(/^[0-9]{7,15}$/)) { mostrarToast('El teléfono debe ser numérico y válido.'); return; }
  if (!fechaEntrega) { mostrarToast('Debes seleccionar la fecha y hora de entrega.'); return; }
  if (entrega === 'si' && !direccion) { mostrarToast('Debes ingresar una dirección.'); return; }
  if (entrega === 'si' && !reparto) { mostrarToast('Debes seleccionar el reparto.'); return; }
  let subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
  let envio = calcularEnvio();
  let total = subtotal + envio;
  let ticket = "PED-" + Date.now() + "-" + Math.floor(Math.random()*1000);
  function b(s){return `*${s}*`;}
  let resumenHtml = `
    <div class="modal-section"><b>🧾 Ticket:</b> <span style="font-size:1.07em;">${ticket}</span></div>
    <div class="modal-section"><b>🍰 Productos:</b>
      <ul style="list-style:none;padding:0; margin:5px 0 0 0;">
        ${carrito.map(i=>`<li style="margin-bottom:3px;">${i.nombre}${i.rellenos?' ('+i.rellenos+')':''} x${i.cantidad} = ${i.precio * i.cantidad} CUP</li>`).join("")}
      </ul>
    </div>
    <div class="modal-section"><b>👤 Cliente:</b> ${nombre}</div>
    <div class="modal-section"><b>📞 Tel:</b> +${codigoPais} ${telefono}</div>
    ${entrega==="si"?`<div class="modal-section"><b>🏠 Dirección:</b> ${direccion}</div>`:""}
    ${entrega==="si"?`<div class="modal-section"><b>📍 Reparto:</b> ${reparto}</div>`:""}
    <div class="modal-section"><b>🚚 Entrega:</b> ${entrega==="si"?"A domicilio":"Retiro en tienda"}</div>
    <div class="modal-section"><b>📅 Fecha y hora:</b> ${fechaEntrega.replace("T"," ")}</div>
    ${especificaciones?`<div class="modal-section"><b>📋 Especificaciones:</b> ${especificaciones}</div>`:""}
    <div class="modal-section" style="margin-top:6px;">
      <div style="color:#3b2eae;font-weight:bold;">Subtotal: <span style="color:#222;">${b(subtotal+" CUP")}</span></div>
      <div style="color:#3b2eae;font-weight:bold;">Envío: <span style="color:#222;">${b(envio+" CUP")}</span></div>
      <div style="color:#25D366;font-weight:bold;font-size:1.12em;">TOTAL: <span style="color:#222;">${b(total+" CUP")}</span></div>
    </div>
  `;
  let modal = document.createElement('div');
  modal.className = "modal-bg";
  modal.innerHTML = `
    <div class="modal-confirm">
      <h2>Confirmar pedido</h2>
      ${resumenHtml}
      <div class="modal-btns">
        <button class="btn-cancelar" onclick="document.body.removeChild(this.closest('.modal-bg'));">Cancelar</button>
        <button class="btn-confirmar" onclick="confirmarEnvioPedido('${ticket}')">Confirmar y enviar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
function confirmarEnvioPedido(ticket) {
  enviarPedido(ticket);
  document.body.querySelector('.modal-bg')?.remove();
}
function enviarPedido(ticket) {
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const direccion = document.getElementById('direccion').value.trim();
  const reparto = document.getElementById('reparto').value.trim();
  const codigoPais = document.getElementById('codigoPais').value.trim();
  const entrega = document.getElementById('entrega').value;
  const fechaEntrega = document.getElementById('fechaEntrega').value;
  const especificaciones = document.getElementById('especificaciones').value.trim();
  let subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
  let envio = calcularEnvio();
  let total = subtotal + envio;
  let productosResumen = carrito.map(i =>
    `${i.nombre}${i.rellenos?' ('+i.rellenos+')':''} x${i.cantidad}`
  ).join('; ');
  fetch("https://script.google.com/macros/s/AKfycbxnYsciq5EhfzgcgcF2FnyGECGarxqmF7zdDI0R9bizekqvB48W0RdBA4zZ0EGkDlWt/exec", {
    method: "POST",
    body: new URLSearchParams({
      nombre,
      telefono,
      direccion,
      reparto,
      codigo_pais: codigoPais,
      productos: productosResumen,
      especificaciones,
      subtotal,
      envio,
      total,
      entrega,
      fecha_entrega: fechaEntrega,
      estado: "Pendiente",
      ticket
    })
  }).then(r=>r.text()).then(resp=>{
    if(resp.startsWith("OK")) {
      mostrarToast("¡Pedido enviado!");
      vaciarCarrito();
      document.getElementById('clienteForm').reset();
      actualizarCarrito();
    } else {
      mostrarToast("Error al guardar el pedido.");
    }
  }).catch(()=>{
    mostrarToast("No se pudo enviar el pedido.");
  });
  // WhatsApp
  function b(s){return `*${s}*`;}
  let resumen = '🧾 *Ticket:* ' + ticket + '\n';
  resumen += '\n🍰 *Productos:*\n';
  carrito.forEach(i => { resumen += `- ${i.nombre}${i.rellenos ? ' ('+i.rellenos+')' : ''} x${i.cantidad} = ${i.precio * i.cantidad} CUP\n`; });
  resumen += '\n👤 *Cliente:* ' + nombre + '\n';
  resumen += '📞 *Tel:* +' + codigoPais + ' ' + telefono + '\n';
  if (direccion) resumen += '🏠 *Dirección:* ' + direccion + '\n';
  if (reparto) resumen += '📍 *Reparto:* ' + reparto + '\n';
  resumen += '🚚 *Entrega:* ' + (entrega==="si"?"A domicilio":"Retiro en tienda") + '\n';
  resumen += '📅 *Fecha y hora:* ' + fechaEntrega.replace("T"," ") + '\n';
  if (especificaciones) resumen += '📋 *Especificaciones:* ' + especificaciones + '\n';
  resumen += '\n============================\n';
  resumen += '💲 *Subtotal:* ' + b(subtotal+" CUP") + '\n';
  resumen += '📦 *Envío:* ' + b(envio+" CUP") + '\n';
  resumen += '💰 *TOTAL:* ' + b(total+" CUP") + '\n';
  resumen += '============================';
  let numeroWsp = "5358707434";
  let urlWsp = `https://wa.me/${numeroWsp}?text=${encodeURIComponent(resumen)}`;
  setTimeout(()=>{ window.open(urlWsp, '_blank'); }, 350);
}
</script>
</body>
</html>
