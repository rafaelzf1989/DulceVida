<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dulce Vida</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    /* Loader styles */
    #loader {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.93);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: opacity 0.4s;
      font-size: 1.4em;
    }
    #loader.oculto {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
    }
    .loader-spinner {
      border: 6px solid #eee;
      border-top: 6px solid #25D366;
      border-radius: 50%;
      width: 46px;
      height: 46px;
      animation: spin 1s linear infinite;
      margin-bottom: 18px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    header {
      background: #fff;
      padding: 10px;
      text-align: center;
      border-bottom: 2px solid #ccc;
    }

    header img {
      max-width: 100%;
      height: auto;
    }

    .marquesina {
      background: #25D366;
      color: white;
      padding: 10px;
      font-weight: bold;
    }

    .productos {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      padding: 20px;
    }

    .producto {
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px;
      width: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      transition: box-shadow 0.2s, transform 0.2s;
    }

    /* --- SUGERENCIAS VISUALES Y EST√âTICA --- */

    /* Efecto hover en tarjetas de producto */
    .producto:hover {
      box-shadow: 0 4px 14px rgba(37,211,102,0.16);
      transform: translateY(-2px) scale(1.02);
      z-index: 1;
    }

    /* Aumenta el tama√±o de los botones principales */
    .producto button,
    #cliente button {
      font-size: 1.07em;
      padding: 10px 16px;
    }

    /* Espaciado extra entre secciones */
    section {
      margin-bottom: 32px;
    }

    /* Separador visual entre productos y carrito */
    #carrito {
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.03);
      padding-top: 20px;
      margin-top: 16px;
    }

    /* Carrito flotante animaci√≥n al agregar */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(37,211,102,0.5);}
      100% { box-shadow: 0 0 0 18px rgba(37,211,102,0);}
    }
    #carritoFlotante.pulse {
      animation: pulse 0.4s;
    }

    /* --- FIN DE SUGERENCIAS VISUALES Y EST√âTICA --- */

    .producto img {
      width: 180px;
      height: 180px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 5px;
    }

    .producto h3 {
      margin: 5px 0 2px;
      font-size: 1.1em;
    }

    .producto p {
      margin: 4px 0;
      font-size: 0.95em;
    }

    .producto button {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
    }

    .producto button:hover {
      background: #1e7e34;
    }

    .control-cantidad {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 6px;
    }

    .control-cantidad button {
      background: #4b2e1e; /* caf√© oscuro */
      color: white;
      border: none;
      padding: 6px 10px;
      width: 34px;
      height: 34px;
      font-size: 1.2em;
      border-radius: 4px;
      cursor: pointer;
    }

    .control-cantidad span {
      font-weight: bold;
      font-size: 1.1em;
      min-width: 24px;
      text-align: center;
    }

    #carritoFlotante {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(37, 211, 102, 0.9); /* verde WhatsApp con transparencia */
      color: white;
      padding: 10px 14px;
      border-radius: 50px;
      font-size: 1.2em;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 999;
    }

    #carritoFlotante span {
      background: white;
      color: #25D366;
      border-radius: 50%;
      padding: 2px 8px;
      font-size: 0.9em;
    }

    .producto.agotado img {
      filter: grayscale(100%) brightness(0.9);
      opacity: 0.7;
    }
    .etiqueta {
      position: absolute;
      background: rgba(255, 87, 34, 0.9); /* naranja fuerte */
      color: white;
      font-size: 0.75em;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 0 0 6px 0;
      top: 0;
      left: 0;
      z-index: 2;
    }
    .producto {
      position: relative;
    }
    #cliente {
      max-width: 500px;
      margin: 30px auto;
      background: #fff;
      padding: 20px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #cliente h3 {
      margin-top: 0;
      text-align: center;
      font-size: 1.3em;
      color: #25D366;
    }
    #cliente label {
      display: block;
      margin-top: 12px;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    #cliente input,
    #cliente select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.95em;
      box-sizing: border-box;
    }
    #cliente input:focus,
    #cliente select:focus {
      border-color: #25D366;
      outline: none;
      box-shadow: 0 0 0 2px #25D36666;
    }
    #zonaEntrega {
      margin-top: 10px;
      display: none;
    }
    #cliente button {
      background: #25D366;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: block;
      margin: 20px auto 5px;
    }
    #cliente button:hover {
      background: #1ebd5a;
    }
    #mensajeCompra {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
    /* Responsive mejoras */
    @media (max-width: 600px) {
      .productos {
        flex-direction: column;
        align-items: center;
      }
      .producto {
        width: 92vw;
        max-width: 340px;
      }
    }

    /* Carrito vac√≠o */
#carritoVacio {
  color: #888;
  font-size: 1.1em;
  margin: 18px 0;
}

#vaciarCarrito {
  background: #e74c3c;
  color: #fff;
  border: none;
  border-radius: 5px;
  padding: 8px 16px;
  margin: 12px 0 18px 0;
  cursor: pointer;
  font-size: 1em;
  transition: background 0.2s;
}
#vaciarCarrito:hover, #vaciarCarrito:focus {
  background: #c0392b;
}

#resumenTotales {
  background: #f7f7f7;
  border: 2px solid #25D366;
  border-radius: 10px;
  padding: 16px 20px;
  margin: 12px 0 0 0;
  font-size: 1.1em;
  box-shadow: 0 4px 14px rgba(37,211,102,0.07);
  position: sticky;
  top: 10px;
  z-index: 10;
}

.carrito-item-animado {
  animation: flashCarrito 0.5s;
}
@keyframes flashCarrito {
  0% { background: #e8ffe7;}
  100% { background: transparent;}
}

.carrito-cantidad-btn {
  background: #25D366;
  color: white;
  border: none;
  border-radius: 3px;
  width: 28px;
  height: 28px;
  font-size: 1.1em;
  cursor: pointer;
  margin: 0 2px;
  transition: background 0.2s;
}
.carrito-cantidad-btn:active {
  background: #1ebd5a;
}
.carrito-cantidad-btn[disabled] {
  background: #ccc;
  cursor: not-allowed;
}

@media (max-width: 600px) {
  #resumenTotales {
    padding: 14px 6vw;
    font-size: 1em;
  }
  #carrito {
    padding-left: 2vw;
    padding-right: 2vw;
  }
}
  </style>
</head>




<body>
<!-- Loader -->
<div id="loader">
  <div class="loader-spinner"></div>
  Cargando, por favor espere...
</div>

<header>
  <img src="https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/cabecera%20Dulce%20Vida%20WhatsApp.png" alt="Dulce Vida" />
</header>

<div class="marquesina">
  <marquee behavior="scroll" direction="left" scrollamount="10">
    üéâ ¬°Bienvenido a Dulce Vida! Haz tu pedido con tiempo y vive la experiencia de un dulce momento üéÇ‚ú® üöö Entregamos a domicilio toda la semana üìÖ Los pedidos deben realizarse con al menos un d√≠a de antelaci√≥n. ¬°Gracias por preferirnos!
  </marquee>
</div>

<main>
  <section id="productos" class="productos"></section>
  <!-- ...dentro de tu secci√≥n del carrito... -->
<section id="carrito" style="max-width: 500px; margin: auto; text-align: left;">
  <h2>Carrito üõí</h2>
  <ul id="listaCarrito" style="padding-left: 20px; min-height: 55px;"></ul>

  <!-- Mensaje cuando el carrito est√° vac√≠o -->
  <div id="carritoVacio" style="display:none; text-align:center; color:#888; margin-top:20px;">
    Tu carrito est√° vac√≠o. ¬°Agrega algo delicioso!
  </div>

  <!-- Bot√≥n para vaciar carrito -->
  <button id="vaciarCarrito" style="display:none; background:#e74c3c; color:#fff; border:none; border-radius:5px; padding:8px 16px; margin:12px 0 18px 0; cursor:pointer;">
    Vaciar carrito
  </button>

  <!-- Resumen fijo y destacado -->
  <div id="resumenTotales" style="background: #f7f7f7; border: 2px solid #25D366; border-radius: 10px; padding: 16px 20px; margin: 12px 0 0 0; font-size:1.1em;">
    <p>Subtotal: <span id="totalCarrito">0</span> CUP</p>
    <p>Env√≠o: <span id="tarifaReparto">0</span> CUP</p>
    <p style="font-size:1.2em;"><strong>Total: <span id="totalFinal">0</span> CUP</strong></p>
  </div>
</section>

  <section id="cliente">
    <h3>üìù Datos del Cliente</h3>
    <label for="codigoPais">C√≥digo de pa√≠s <span style="color:red">*</span></label>
    <select id="codigoPais" required>
      <option disabled selected>Selecciona tu pa√≠s</option>
      <option value="53">üá®üá∫ Cuba (+53)</option>
      <option value="1">üá∫üá∏ EE. UU. (+1)</option>
      <option value="34">üá™üá∏ Espa√±a (+34)</option>
      <option value="52">üá≤üáΩ M√©xico (+52)</option>
      <option value="55">üáßüá∑ Brasil (+55)</option>
    </select>
    <label for="telefono">N√∫mero de tel√©fono <span style="color:red">*</span></label>
    <input id="telefono" type="tel" placeholder="Ej: 52123456" required />
    <label for="nombre">Nombre completo <span style="color:red">*</span></label>
    <input id="nombre" type="text" placeholder="Tu nombre y apellidos" required />
    <label for="entrega">¬øDeseas entrega a domicilio? <span style="color:red">*</span></label>
    <select id="entrega" onchange="toggleDireccion()" required>
      <option value="">Selecciona una opci√≥n</option>
      <option value="si">S√≠</option>
      <option value="no">No</option>
    </select>
    <div id="zonaEntrega">
      <label for="direccion">Direcci√≥n exacta <span style="color:red">*</span></label>
      <input id="direccion" type="text" placeholder="Ej: Calle 10 #123 entre A y B" />
      <label for="reparto">Reparto o zona <span style="color:red">*</span></label>
      <select id="reparto" onchange="actualizarTarifa()">
        <option disabled selected>Selecciona tu reparto</option>
        <option>Santa Luc√≠a</option>
        <option>Tasajera</option>
        <option>Las Casitas</option>
        <option>Progreso</option>
        <option>Nuevo Progreso</option>
        <option>Cepero Bonilla</option>
        <option>El Tri√°ngulo</option>
        <option>Alba Flores</option>
        <option>Borboll√≥n</option>
        <option>La Compa√±√≠a</option>
        <option>La Maravilla</option>
      </select>
    </div>
    <label for="fechaEntrega">Fecha y hora deseada de entrega <span style="color:red">*</span></label>
    <input type="datetime-local" id="fechaEntrega" required />
    <button id="btnEnviar" style="display: flex; align-items: center; gap: 8px;" disabled>
      <img src="https://file.garden/aEX2yhToiQk-s_Qq/IMG_COM_202506261242078500.png"
           alt="Icono WhatsApp"
           style="width: 20px; height: 20px; object-fit: contain;" />
      Enviar por WhatsApp
    </button>
    <p id="mensajeCompra"></p>
  </section>
</main>

<!-- Formulario oculto para Google Sheets -->
<form id="sheetForm"
  action="https://script.google.com/macros/s/AKfycby4SAL62SMWK1sn0e9ddVYzyXneQP1VssYRtldtIGCgesqmQtJgxKkIh0_VF6ahhLhU/exec"
  method="post" target="sheetResponse" style="display:none;">
  <input name="nombre"         id="f_nombre" />
  <input name="telefono"       id="f_telefono" />
  <input name="direccion"      id="f_direccion" />
  <input name="reparto"        id="f_reparto" />
  <input name="codigoPais"     id="f_codigoPais" />
  <input name="productos"      id="f_productos" />
  <input name="subtotal"       id="f_subtotal" />
  <input name="envio"          id="f_envio" />
  <input name="total"          id="f_total" />
  <input name="entrega"        id="f_entrega" />
  <input name="fecha_entrega"  id="f_fecha_entrega" />
  <input name="estado" id="f_estado" />
  <input name="ticket" id="f_ticket" />
</form>
<iframe name="sheetResponse" style="display:none;"></iframe>

<!-- MODAL DE CONFIRMACI√ìN -->
<div id="modalResumen" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.35); z-index:3000; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:10px; max-width:90vw; width:340px; margin:auto; padding:22px 18px; box-shadow:0 6px 24px rgba(0,0,0,0.25); position:relative;">
    <h3 style="margin-top:0; color:#25D366;">¬øConfirmar pedido?</h3>
    <div id="resumenPedido" style="font-size:1em; margin-bottom:16px;"></div>
    <button id="btnConfirmarEnviar" style="background:#25D366; color:#fff; border:none; border-radius:6px; padding:10px 20px; font-size:1.1em; margin-right:10px; cursor:pointer;">S√≠, enviar</button>
    <button onclick="cerrarModalResumen()" style="background:#eee; color:#333; border:none; border-radius:6px; padding:10px 18px; font-size:1em; cursor:pointer;">Cancelar</button>
  </div>
</div>

<div id="carritoFlotante" onclick="irAlCarrito()" role="button" aria-label="Ver carrito de compras" tabindex="0">
  üõí <span id="contadorCarrito">0</span>
</div>



<script>
let estadosProductos = {};
let carrito = [];
const cantidadesSeleccionadas = {};
const tarifas = {
  'Santa Luc√≠a': 50, 'Tasajera': 50, 'Las Casitas': 50,
  'Progreso': 50, 'Nuevo Progreso': 50,
  'Cepero Bonilla': 100, 'El Tri√°ngulo': 100,
  'Alba Flores': 100, 'Borboll√≥n': 100,
  'La Compa√±√≠a': 100, 'La Maravilla': 100
};
const productos = [
  {
    id: 1,
    nombre: 'Panetela Cl√°sica',
    precio: 3500,
    descripcion: 'Bizcocho suave y esponjoso con aroma a vainilla.',
    img: 'https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/clasica.png'
  },
  {
    id: 2,
    nombre: 'Panetela de Chocolate',
    precio: 3800,
    descripcion: 'Rellena de chocolate con cubierta de cacao oscuro.',
    img: 'https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/chocolate.png'
  },
  {
    id: 3,
    nombre: 'Panetela Especial',
    precio: 4300,
    descripcion: 'Decorada con crema batida y frutas confitadas.',
    img: 'https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/especial%201.png'
  }
];

// Loader
document.getElementById('loader').style.display = "flex";
fetch("https://script.google.com/macros/s/AKfycby4SAL62SMWK1sn0e9ddVYzyXneQP1VssYRtldtIGCgesqmQtJgxKkIh0_VF6ahhLhU/exec?func=obtenerEstadosProductos")
  .then(respuesta => respuesta.json())
  .then(data => {
    estadosProductos = data;
    cargarProductos();
    setTimeout(() => {
      document.getElementById('loader').classList.add("oculto");
      setTimeout(() => { document.getElementById('loader').style.display = "none"; }, 400);
    }, 250);
  })
  .catch(() => {
    setTimeout(() => {
      document.getElementById('loader').classList.add("oculto");
      setTimeout(() => { document.getElementById('loader').style.display = "none"; }, 400);
    }, 600);
  });

// --- Persistencia carrito localStorage ---
if (localStorage.getItem('carrito')) {
  try {
    carrito = JSON.parse(localStorage.getItem('carrito'));
  } catch(e) { carrito = []; }
}
function guardarCarrito() {
  localStorage.setItem('carrito', JSON.stringify(carrito));
}

// --- Productos y control de cantidades ---
function modificarCantidad(id, delta) {
  if (!cantidadesSeleccionadas[id]) cantidadesSeleccionadas[id] = 0;
  cantidadesSeleccionadas[id] += delta;
  if (cantidadesSeleccionadas[id] < 0) cantidadesSeleccionadas[id] = 0;
  document.getElementById(`cantidad-${id}`).textContent = cantidadesSeleccionadas[id];
}
function agregarAlCarritoDesdeBoton(id) {
  const cantidad = cantidadesSeleccionadas[id] || 0;
  if (cantidad === 0) {
    alert("Selecciona al menos una unidad para agregar.");
    return;
  }
  const producto = productos.find(p => p.id === id);
  const existe = carrito.find(i => i.id === id);
  if (existe) {
    existe.cantidad += cantidad;
  } else {
    carrito.push({ ...producto, cantidad });
  }
  cantidadesSeleccionadas[id] = 0;
  document.getElementById(`cantidad-${id}`).textContent = 0;
  actualizarCarrito();
  // Feedback visual
  const carritoFlot = document.getElementById('carritoFlotante');
  carritoFlot.classList.remove('pulse');
  void carritoFlot.offsetWidth;
  carritoFlot.classList.add('pulse');
  setTimeout(() => carritoFlot.classList.remove('pulse'), 500);
}
function cargarProductos() {
  const cont = document.getElementById('productos');
  cont.innerHTML = '';
  productos.forEach(p => {
    const div = document.createElement('div');
    div.className = 'producto';
    const estado = estadosProductos[p.nombre] || '';
    const agotado = estado.toLowerCase().includes('agotado');
    if (agotado) div.classList.add('agotado');
    div.innerHTML = `
      ${estado ? `<div class="etiqueta">${estado}</div>` : ''}
      <img src="${p.img}" alt="${p.nombre}" />
      <h3>${p.nombre}</h3>
      <p>${p.descripcion}</p>
      <p><strong>${p.precio} CUP</strong></p>
      <div class="control-cantidad">
        <button onclick="modificarCantidad(${p.id}, -1)" ${agotado ? 'disabled' : ''}>‚àí</button>
        <span id="cantidad-${p.id}">0</span>
        <button onclick="modificarCantidad(${p.id}, 1)" ${agotado ? 'disabled' : ''}>+</button>
      </div>
      ${agotado
        ? `<button disabled style="background: gray; cursor: not-allowed;">No disponible</button>`
        : `<button onclick="agregarAlCarritoDesdeBoton(${p.id})">A√±adir al carrito</button>`}
    `;
    cont.appendChild(div);
  });
  actualizarCarrito();
}
function quitarDelCarrito(id) {
  carrito = carrito.filter(i => i.id !== id);
  actualizarCarrito();
}

// --- Carrito, totales, tarifas ---
// --- ACTUALIZAR CARRITO CON MEJORAS ---
function actualizarCarrito() {
  const listaCarrito = document.getElementById('listaCarrito');
  const vaciarCarritoBtn = document.getElementById('vaciarCarrito');
  const carritoVacioMsg = document.getElementById('carritoVacio');
  listaCarrito.innerHTML = '';
  let subtotal = 0;
  let totalItems = 0;
  carrito.forEach(item => {
    subtotal += item.precio * item.cantidad;
    totalItems += item.cantidad;
    const agotado = (typeof estadosProductos !== "undefined" && estadosProductos[item.nombre] && estadosProductos[item.nombre].toLowerCase().includes('agotado'));
    const li = document.createElement('li');
    li.style.textAlign = 'left';
    li.style.marginBottom = '10px';
    li.className = 'carrito-item-animado';
    li.innerHTML = `
      <strong>${item.nombre}</strong>
      <div style="display:inline-block; margin-left:8px;">
        <button class="carrito-cantidad-btn" onclick="cambiarCantidadCarrito(${item.id}, -1)" ${item.cantidad <= 1 ? 'disabled' : ''} aria-label="Disminuir cantidad">-</button>
        <span style="margin:0 6px; font-weight:bold;">${item.cantidad}</span>
        <button class="carrito-cantidad-btn" onclick="cambiarCantidadCarrito(${item.id}, 1)" ${agotado ? 'disabled' : ''} aria-label="Aumentar cantidad">+</button>
      </div>
      <span style="margin-left:14px;">${item.precio * item.cantidad} CUP</span>
      <button onclick="quitarDelCarrito(${item.id})" title="Quitar" style="background:none; color:#e74c3c; border:none; font-size:1.2em; cursor:pointer;" aria-label="Quitar producto">&times;</button>
      ${agotado ? '<span style="color:#e74c3c; font-size:0.9em;"> (Agotado)</span>' : ''}
    `;
    listaCarrito.appendChild(li);
    setTimeout(() => li.classList.remove('carrito-item-animado'), 500);
  });
  document.getElementById('totalCarrito').textContent = subtotal;
  actualizarTarifa();
  document.getElementById('contadorCarrito').textContent = totalItems;
  actualizarEstadoBotonEnviar();
  if (carrito.length === 0) {
    carritoVacioMsg.style.display = 'block';
    vaciarCarritoBtn.style.display = 'none';
  } else {
    carritoVacioMsg.style.display = 'none';
    vaciarCarritoBtn.style.display = 'inline-block';
  }
  localStorage.setItem('carrito', JSON.stringify(carrito));
}

// --- CAMBIAR CANTIDAD EN CARRITO ---
function cambiarCantidadCarrito(id, delta) {
  const prod = carrito.find(i => i.id === id);
  if (!prod) return;
  prod.cantidad += delta;
  if (prod.cantidad <= 0) quitarDelCarrito(id);
  else actualizarCarrito();
}

// --- BOT√ìN VACIAR CARRITO ---
document.getElementById('vaciarCarrito').onclick = function() {
  if (carrito.length === 0) return;
  if (confirm('¬øSeguro que quieres vaciar tu carrito? Esta acci√≥n no se puede deshacer.')) {
    carrito = [];
    actualizarCarrito();
    localStorage.removeItem('carrito');
  }
};

// --- SINCRONIZACI√ìN ENTRE PESTA√ëAS ---
window.addEventListener('storage', function(e) {
  if (e.key === 'carrito') {
    try {
      carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
      actualizarCarrito();
    } catch { /* ignore */ }
  }
});

// --- AGREGAR AL CARRITO DESDE BOT√ìN (evita duplicados y feedback) ---
function agregarAlCarritoDesdeBoton(id) {
  const cantidad = cantidadesSeleccionadas[id] || 0;
  if (cantidad === 0) {
    alert("Selecciona al menos una unidad para agregar.");
    return;
  }
  const producto = productos.find(p => p.id === id);
  let existe = carrito.find(i => i.id === id);
  if (existe) {
    existe.cantidad += cantidad;
    setTimeout(() => {
      const items = document.querySelectorAll('#listaCarrito li');
      items.forEach(li => {
        if (li.textContent.includes(producto.nombre)) {
          li.classList.add('carrito-item-animado');
          setTimeout(() => li.classList.remove('carrito-item-animado'), 500);
        }
      });
    }, 50);
  } else {
    carrito.push({ ...producto, cantidad });
  }
  cantidadesSeleccionadas[id] = 0;
  document.getElementById(`cantidad-${id}`).textContent = 0;
  actualizarCarrito();
  const carritoFlot = document.getElementById('carritoFlotante');
  carritoFlot.classList.remove('pulse');
  void carritoFlot.offsetWidth;
  carritoFlot.classList.add('pulse');
  setTimeout(() => carritoFlot.classList.remove('pulse'), 500);
}

// --- Validaci√≥n avanzada de formulario ---
function marcarCamposObligatorios() {
  let error = false;
  const campos = [
    {id: 'codigoPais', tipo: 'select'},
    {id: 'telefono'},
    {id: 'nombre'},
    {id: 'entrega', tipo: 'select'},
    {id: 'fechaEntrega'}
  ];
  campos.forEach(({id, tipo}) => {
    const elem = document.getElementById(id);
    const valor = (tipo === 'select') ? elem.value : elem.value.trim();
    if (!valor || valor === "" || valor === "Selecciona tu pa√≠s" || valor === "Selecciona una opci√≥n") {
      elem.style.borderColor = "red";
      error = true;
    } else {
      elem.style.borderColor = "#ccc";
    }
  });
  if (document.getElementById('entrega').value === "si") {
    ['direccion', 'reparto'].forEach(id => {
      const elem = document.getElementById(id);
      const valor = elem.value.trim();
      if (!valor || valor === "" || valor === "Selecciona tu reparto") {
        elem.style.borderColor = "red";
        error = true;
      } else {
        elem.style.borderColor = "#ccc";
      }
    });
  } else {
    ['direccion', 'reparto'].forEach(id => {
      document.getElementById(id).style.borderColor = "#ccc";
    });
  }
  return error;
}
function formularioCompleto() {
  if(carrito.length === 0) return false;
  if(!document.getElementById('codigoPais').value ||
    !document.getElementById('telefono').value.trim() ||
    !document.getElementById('nombre').value.trim() ||
    !document.getElementById('entrega').value ||
    !document.getElementById('fechaEntrega').value
  ) return false;
  if(document.getElementById('entrega').value === "si" &&
    (
      !document.getElementById('direccion').value.trim() ||
      !document.getElementById('reparto').value ||
      document.getElementById('reparto').value === "Selecciona tu reparto"
    )
  ) return false;
  return true;
}
function actualizarEstadoBotonEnviar() {
  document.getElementById('btnEnviar').disabled = !formularioCompleto();
}
["codigoPais", "telefono", "nombre", "entrega", "fechaEntrega", "direccion", "reparto"].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('input', actualizarEstadoBotonEnviar);
    el.addEventListener('change', actualizarEstadoBotonEnviar);
  }
});

// --- Modal de confirmaci√≥n ---
const btnEnviar = document.getElementById('btnEnviar');
if(btnEnviar) {
  btnEnviar.onclick = mostrarModalResumen;
}
function mostrarModalResumen(e) {
  if(e) e.preventDefault();
  if(carrito.length === 0) {
    alert('El carrito est√° vac√≠o.');
    return;
  }
  if (typeof marcarCamposObligatorios === "function" && marcarCamposObligatorios()) {
    alert('Por favor, completa todos los campos requeridos.');
    return;
  }
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const codigoPais = document.getElementById('codigoPais').value;
  const entrega = document.getElementById('entrega').value;
  const direccion = entrega === 'si' ? document.getElementById('direccion').value.trim() : '';
  const reparto = entrega === 'si' ? document.getElementById('reparto').value : '';
  const fechaEntrega = document.getElementById('fechaEntrega').value;
  const subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
  const envio = entrega === 'si' ? (tarifas[reparto] || 0) : 0;
  const total = subtotal + envio;
  let html = `<strong>Productos:</strong><br>`;
  carrito.forEach(i => {
    html += `üç∞ ${i.nombre} x${i.cantidad} = ${i.precio * i.cantidad} CUP<br>`;
  });
  html += `<br>üöö <strong>Reparto:</strong> ${reparto || 'Sin reparto'} (+${envio} CUP)<br>`;
  html += `üí∞ <strong>Subtotal:</strong> ${subtotal} CUP<br>`;
  html += `<strong>Total:</strong> ${total} CUP<br>`;
  html += `<br>üë§ ${nombre}<br>üìû +${codigoPais} ${telefono}<br>`;
  if(direccion) html += `üè† ${direccion}<br>`;
  if(fechaEntrega) html += `üìÖ Entrega: ${new Date(fechaEntrega).toLocaleString("es-ES")}<br>`;
  document.getElementById('resumenPedido').innerHTML = html;
  document.getElementById('modalResumen').style.display = "flex";
}
document.getElementById('btnConfirmarEnviar').onclick = function() {
  document.getElementById('modalResumen').style.display = "none";
  enviarPedidoFinal();
};
function cerrarModalResumen() {
  document.getElementById('modalResumen').style.display = "none";
}

// --- Enviar pedido final ---
function enviarPedidoFinal() {
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const codigoPais = document.getElementById('codigoPais').value;
  const entrega = document.getElementById('entrega').value;
  const direccion = entrega === 'si' ? document.getElementById('direccion').value.trim() : '';
  const reparto = entrega === 'si' ? document.getElementById('reparto').value : '';
  const fechaEntrega = document.getElementById('fechaEntrega').value;
  const ticket = `PED-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
  document.getElementById('f_ticket').value = ticket;

  const telefonoLimpio = telefono.startsWith(codigoPais)
    ? telefono.slice(codigoPais.length)
    : telefono;

  const subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
  const envio = entrega === 'si' ? (tarifas[reparto] || 0) : 0;
  const total = subtotal + envio;
  const productosTxt = carrito.map(i => `${i.nombre} x${i.cantidad}`).join(', ');

  // Llenar el formulario oculto
  document.getElementById('f_nombre').value = nombre;
  document.getElementById('f_telefono').value = telefonoLimpio;
  document.getElementById('f_codigoPais').value = codigoPais;
  document.getElementById('f_direccion').value = direccion;
  document.getElementById('f_reparto').value = reparto;
  document.getElementById('f_productos').value = productosTxt;
  document.getElementById('f_subtotal').value = subtotal;
  document.getElementById('f_envio').value = envio;
  document.getElementById('f_total').value = total;
  document.getElementById('f_entrega').value = entrega;
  document.getElementById('f_fecha_entrega').value = fechaEntrega;
  document.getElementById('f_estado').value = "Pendiente";

  document.getElementById('sheetForm').submit();

  // Generar mensaje para WhatsApp (ACTUALIZADO)
  const numero = "5358707434";
  let texto = '';
  texto += 'üßæ *Ticket de Compra* üßæ\n';
  texto += `*Ticket:* ${ticket}\n`;
  texto += '-------------------------\n';
  carrito.forEach(i => {
    texto += `üç∞ ${i.nombre} x${i.cantidad} = ${i.precio * i.cantidad} CUP\n`;
  });
  texto += `-------------------------\n`;
  texto += `üöö Reparto: ${reparto || 'Sin reparto'} (+${envio} CUP)\n`;
  texto += `üí∞ Subtotal: ${subtotal} CUP\n`;
  texto += `*Total:* \`${total} CUP\`\n`;
  texto += `-------------------------\n`;
  texto += `üë§ ${nombre}\n`;
  texto += `üìû +${codigoPais} ${telefonoLimpio}\n`;
  if (direccion) texto += `üè† ${direccion}\n`;
  if (fechaEntrega) texto += `üìÖ Entrega: ${new Date(fechaEntrega).toLocaleString("es-ES")}\n`;

  window.open(`https://wa.me/${numero}?text=${encodeURIComponent(texto)}`, '_blank');

  // Limpiar todo
  carrito = [];
  actualizarCarrito();
  localStorage.removeItem('carrito');
  document.getElementById('nombre').value = '';
  document.getElementById('telefono').value = '';
  document.getElementById('codigoPais').selectedIndex = 0;
  document.getElementById('direccion').value = '';
  document.getElementById('reparto').selectedIndex = 0;
  document.getElementById('entrega').selectedIndex = 0;
  document.getElementById('fechaEntrega').value = '';
  document.getElementById('zonaEntrega').style.display = 'none';
  document.getElementById('mensajeCompra').textContent = '';
  actualizarEstadoBotonEnviar();
}

// --- Accesibilidad y responsive ---
document.querySelectorAll('#cliente input, #cliente select').forEach(el => {
  el.addEventListener('focus', function() {
    this.style.boxShadow = '0 0 0 2px #25D36666';
  });
  el.addEventListener('blur', function() {
    this.style.boxShadow = 'none';
  });
});
window.addEventListener('resize', adaptarProductos);
function adaptarProductos() {
  const productosCont = document.getElementById('productos');
  if(window.innerWidth < 600 && productosCont) {
    productosCont.style.flexDirection = 'column';
    productosCont.style.alignItems = 'center';
  } else if(productosCont) {
    productosCont.style.flexDirection = '';
    productosCont.style.alignItems = '';
  }
}
adaptarProductos();
</script>
</body>
</html>
  
