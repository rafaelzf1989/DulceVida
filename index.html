<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Dulce Vida</title>
  <link rel="icon" type="image/png" href="https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/favicon.png">
  <style>
    body {
      background-color: #f5f5f5;
      color: #202020;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      width: 100vw;
      max-width: 100vw;
      overflow-x: hidden;
    }
    header {
      background: #fff;
      padding: 10px 10px 0 10px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-bottom: 2px solid #ccc;
      max-width: 100vw;
      overflow: hidden;
    }
    header img {
      max-width: 170px;
      height: auto;
      margin: 10px auto 0 auto;
      display: block;
    }
    .marquesina {
      background: #25D366;
      color: white;
      padding: 0;
      font-weight: bold;
      overflow: hidden;
      position: relative;
      height: 36px;
      display: flex;
      align-items: center;
      max-width: 100vw;
      font-size: 1em;
    }
    .marquesina .infinite-scroll {
      display: flex;
      width: max-content;
      animation: scroll-infinite 24s linear infinite;
    }
    .marquesina .infinite-scroll span {
      white-space: nowrap;
      padding-right: 60px;
    }
    @keyframes scroll-infinite {
      0% { transform: translateX(0);}
      100% { transform: translateX(-50%);}
    }
    #productos {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      justify-content: center;
      margin: 18px auto 15px auto;
      max-width: 1100px;
      width: 99vw;
    }
    .producto {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 10px rgba(60,40,120,0.07);
      padding: 20px 16px 16px 16px;
      width: 310px;
      max-width: 95vw;
      margin: 0 3px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: box-shadow 0.2s;
      position: relative;
      min-height: 380px;
    }
    .producto img {
      max-width: 150px;
      max-height: 110px;
      margin-bottom: 12px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 2px 10px #3b2eae13;
    }
    .producto h3 {
      margin: 0 0 7px 0;
      color: #3b2eae;
      font-size: 1.2em;
      font-weight: bold;
    }
    .producto p {
      margin: 0 0 8px 0;
      font-size: 1em;
    }
    .producto .etiqueta {
      position: absolute;
      top: 13px;
      left: 17px;
      background: #3b2eae;
      color: #fff;
      font-size: 0.85em;
      font-weight: bold;
      padding: 4px 12px;
      border-radius: 7px;
      box-shadow: 0 2px 8px #3b2eae18;
      z-index: 5;
    }
    .producto.agotado {
      opacity: 0.5;
      pointer-events: none;
    }
    /* Panetela Especial: controles de relleno */
    .btn-relleno {
      background: #25D366;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 27px;
      height: 27px;
      font-size: 1.2em;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #25d36621;
      transition: background 0.18s;
      margin: 0 2px;
    }
    .btn-relleno:disabled {
      background: #ddd !important;
      color: #aaa !important;
      cursor: not-allowed;
    }
    .producto button {
      background: linear-gradient(60deg,#3b2eae 70%, #25D366 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.1em;
      padding: 10px 32px;
      margin-top: 12px;
      cursor: pointer;
      box-shadow: 0 2px 10px #3b2eae11;
      transition: background 0.2s;
    }
    .producto button:disabled {
      background: gray !important;
      cursor: not-allowed;
    }
    .control-cantidad {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 0 8px 0;
      gap: 8px;
    }
    .control-cantidad button {
      background: #25D366;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      font-size: 1.18em;
      font-weight: bold;
      color: #fff;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 8px #25d36614;
      transition: background 0.18s;
      margin: 0 2px;
    }
    .control-cantidad button:disabled {
      background: #ddd !important;
      color: #aaa !important;
      cursor: not-allowed;
    }
    /* Carrito */
    #carrito {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 10px #3b2eae1a;
      margin: 22px auto 0 auto;
      padding: 18px 18px 8px 18px;
      max-width: 600px;
      width: 99vw;
    }
    #carrito h2 {
      font-size: 1.2em;
      color: #3b2eae;
      margin-bottom: 8px;
    }
    .carrito-controls {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 6px;
    }
    .carrito-controls button {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 17px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 6px;
    }
    .carrito-item {
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #eee;
      padding: 7px 0;
      font-size: 1em;
    }
    .carrito-item:last-child {
      border-bottom: none;
    }
    .carrito-img {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 8px;
      border: 1px solid #eee;
      background: #fafafa;
    }
    .carrito-cantidad-box {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .carrito-cantidad-btn {
      background: #25D366;
      color: #fff;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 6px #25d3661a;
      transition: background 0.18s;
    }
    .carrito-cantidad-btn:disabled {
      background: #ddd;
      color: #aaa;
      cursor: not-allowed;
    }
    .carrito-cantidad-input {
      width: 34px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
      padding: 1px 2px;
    }
    .carrito-totals-row, .carrito-total-row {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 1em;
    }
    .carrito-total-row {
      font-weight: bold;
      color: #3b2eae;
      font-size: 1.1em;
    }
    .carrito-total-valor {
      font-weight: bold;
      color: #25D366;
      font-size: 1.13em;
    }
    .empty-cart {
      text-align: center;
      color: #aaa;
      font-style: italic;
      margin: 16px 0;
    }
    /* Cliente y formulario */
    #cliente {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 10px #3b2eae1a;
      margin: 22px auto 40px auto;
      padding: 18px 18px 10px 18px;
      max-width: 600px;
      width: 99vw;
    }
    #cliente h3 {
      color: #3b2eae;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    #clienteForm label {
      font-weight: bold;
      color: #3b2eae;
      margin-top: 8px;
      display: block;
    }
    #clienteForm input, #clienteForm select {
      margin-bottom: 10px;
      padding: 7px 10px;
      border-radius: 7px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1em;
      margin-top: 2px;
      box-sizing: border-box;
    }
    #clienteForm button {
      background: linear-gradient(60deg,#3b2eae 70%, #25D366 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.1em;
      padding: 10px 32px;
      margin-top: 12px;
      cursor: pointer;
      box-shadow: 0 2px 10px #3b2eae11;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #mensajeCompra {
      color: #25D366;
      font-weight: bold;
      text-align: center;
      margin: 10px 0 0 0;
    }
    /* Loader */
    #loader {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.94);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 1.4em;
      transition: opacity 0.4s;
      opacity: 1;
    }
    #loader.oculto { opacity: 0; pointer-events: none; }
    .loader-spinner {
      border: 6px solid #eee;
      border-top: 6px solid #25D366;
      border-radius: 50%;
      width: 46px;
      height: 46px;
      animation: spin 1s linear infinite;
      margin-bottom: 18px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    /* Modal confirmaci√≥n */
    .modal-bg {
      position: fixed;
      top:0;left:0;right:0;bottom:0;
      background: rgba(0,0,0,0.32);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-confirm {
      background: #fff;
      border-radius: 16px;
      max-width: 380px;
      padding: 24px 14px 14px 14px;
      box-shadow: 0 2px 18px #3b2eae30;
      margin: 0 10px;
      animation: fadeIn 0.18s;
    }
    @keyframes fadeIn { from { transform: scale(0.94); opacity: 0.3; } to { transform: scale(1); opacity: 1; } }
    .modal-section {
      margin-bottom: 10px;
      font-size: 1em;
    }
    .modal-total-row {
      font-weight: bold;
      color: #3b2eae;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      border-top: 1.5px solid #eee;
      padding-top: 5px;
    }
    .modal-total-valor {
      font-weight: bold;
      color: #25D366;
      font-size: 1.13em;
    }
    .modal-btns {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 14px;
    }
    .btn-cancelar {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 18px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-confirmar {
      background: #25D366;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 18px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
    }
    /* Carrito flotante */
    #carritoFlotante {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 4000;
      background: linear-gradient(60deg,#3b2eae 70%, #25D366 100%);
      color: #fff;
      font-size: 1.5em;
      border-radius: 50px;
      padding: 12px 30px 12px 20px;
      box-shadow: 0 2px 14px #231d662c;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 11px;
      transition: background 0.2s, box-shadow 0.2s;
    }
    #carritoFlotante:hover {
      background: #3b2eae;
      box-shadow: 0 2px 18px #231d663a;
    }
    /* Responsive */
    @media (max-width: 700px) {
      #productos { gap: 10px; }
      .producto { width: 98vw; min-width: 0; }
      .carrito-img { width: 30px; height: 30px; }
      #carritoFlotante { padding: 11px 18px 11px 14px; bottom: 14px; right: 8px; font-size: 1.08em;}
      .modal-confirm { padding: 13px 4vw 8px 4vw; }
    }
    @media (max-width: 400px) {
      .modal-confirm { padding: 7px 1vw 5px 1vw; }
      .producto { padding: 10px 2vw 10px 2vw; }
    }
  </style>
</head>
<body>
<div id="loader" aria-label="Cargando p√°gina">
  <div class="loader-spinner"></div>
  Cargando, por favor espere...
</div>
<header>
  <img src="https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/cabecera%20Dulce%20Vida%20WhatsApp.png" alt="Dulce Vida" />
</header>
<div class="marquesina" aria-label="Avisos importantes">
  <div class="infinite-scroll" id="marquesinaScroll"></div>
</div>
<main>
  <section id="productos" class="productos" aria-label="Lista de productos"></section>
  <section id="carrito" style="max-width: 600px; margin: auto; text-align: left; box-sizing:border-box;width:99vw;">
    <div class="carrito-controls" id="carritoControls" style="display:none">
      <button onclick="vaciarCarrito()" title="Vaciar carrito">Vaciar carrito</button>
    </div>
    <h2 style="margin-bottom: 8px;">Carrito üõí</h2>
    <ul id="listaCarrito" style="padding-left: 0; margin:0;"></ul>
    <div class="carrito-totals-row">
      <label>Subtotal:</label>
      <span id="totalCarrito">0</span> CUP
    </div>
    <div class="carrito-totals-row">
      <label>Env√≠o:</label>
      <span id="tarifaReparto">0</span> CUP
    </div>
    <div class="carrito-total-row">
      <label>TOTAL:</label>
      <span class="carrito-total-valor" id="totalFinalBox">0 CUP</span>
    </div>
  </section>
  <section id="cliente" aria-label="Formulario de datos del cliente">
    <h3>üìù Datos del Cliente</h3>
    <form id="clienteForm" autocomplete="off" onsubmit="return false;">
      <label>Nombre completo:</label>
      <input type="text" id="nombre" required maxlength="60" autocomplete="name" placeholder="Ej: Ana P√©rez" />

      <label>Tel√©fono:</label>
      <div style="display: flex; gap: 8px;">
        <select id="codigoPais" style="width: 70px;">
          <option value="53">+53</option>
          <option value="1">+1</option>
          <option value="34">+34</option>
        </select>
        <input type="tel" id="telefono" required maxlength="15" autocomplete="tel" placeholder="Ej: 58707434" pattern="[0-9]+" />
      </div>

      <label>¬øDesea entrega a domicilio?</label>
      <select id="entrega" required onchange="mostrarDireccion()">
        <option value="no" selected>Retiro en tienda</option>
        <option value="si">S√≠, entrega a domicilio</option>
      </select>
      <div id="direccionEntrega" style="display:none;">
        <label>Direcci√≥n:</label>
        <input type="text" id="direccion" maxlength="100" placeholder="Ej: Calle 1ra #100 entre 2 y 4, Vedado" />
        <label>Reparto:</label>
        <select id="reparto" onchange="actualizarTarifa()">
          <option value="">Seleccionar reparto</option>
          <option value="Vedado">Vedado</option>
          <option value="Plaza">Plaza</option>
          <option value="Centro Habana">Centro Habana</option>
          <option value="Playa">Playa</option>
        </select>
      </div>
      <label>Fecha de entrega:</label>
      <input type="date" id="fechaEntrega" required />
      <button id="btnEnviar" type="button" onclick="mostrarResumenConfirmacion()" style="display: flex; align-items: center; gap: 8px;">
        <img src="https://file.garden/aEX2yhToiQk-s_Qq/IMG_COM_202506261242078500.png"
          alt="Icono WhatsApp"
          style="width: 20px; height: 20px; object-fit: contain;" />
        Enviar por WhatsApp
      </button>
    </form>
    <p id="mensajeCompra"></p>
  </section>
</main>
<form id="sheetForm"
  action="https://script.google.com/macros/s/AKfycbxcw9TD2SmgDgimOi3hmJQ7FN7SGTjZN5BIaiIBxGpLeG6_XtFDDqSflQjLoB4X4UT5/exec"
  method="post" target="sheetResponse" style="display:none;">
  <input type="hidden" name="nombre" id="inputNombre" />
  <input type="hidden" name="telefono" id="inputTelefono" />
  <input type="hidden" name="codigoPais" id="inputCodigoPais" />
  <input type="hidden" name="direccion" id="inputDireccion" />
  <input type="hidden" name="reparto" id="inputReparto" />
  <input type="hidden" name="productos" id="inputProductos" />
  <input type="hidden" name="subtotal" id="inputSubtotal" />
  <input type="hidden" name="envio" id="inputEnvio" />
  <input type="hidden" name="total" id="inputTotal" />
  <input type="hidden" name="entrega" id="inputEntrega" />
  <input type="hidden" name="fecha_entrega" id="inputFechaEntrega" />
  <input type="hidden" name="estado" id="inputEstado" />
  <input type="hidden" name="ticket" id="inputTicket" />
</form>
<iframe name="sheetResponse" style="display:none;"></iframe>
<script>
  // Marquesina infinita
  const textoMarquesina = "üéâ ¬°Bienvenido a Dulce Vida! Haz tu pedido con tiempo y vive la experiencia de un dulce momento üéÇ‚ú® üöö Entregamos a domicilio toda la semana üìÖ Los pedidos deben realizarse con al menos 1 d√≠a de antelaci√≥n üìû WhatsApp 5358707434";
  function ponerMarquesinaInfinita() {
    const ms = document.getElementById("marquesinaScroll");
    ms.innerHTML = `<span>${textoMarquesina}</span><span>${textoMarquesina}</span>`;
  }
  ponerMarquesinaInfinita();

  // ==== Variables y funciones principales ====
  let rellenosEspecial = [];
  let rellenosEspecialCargados = false;
  let cantidadesRellenos = [];
  let productos = [
    {
      id: 1,
      nombre: 'Panetela Cl√°sica',
      precio: 3500,
      descripcion: 'Bizcocho suave y esponjoso con aroma a vainilla. Ideal para todo tipo de celebraciones y para acompa√±ar el caf√©.',
      img: 'https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/clasica.png'
    },
    {
      id: 2,
      nombre: 'Panetela de Chocolate',
      precio: 3800,
      descripcion: 'Rellena de chocolate con cubierta de cacao oscuro. Una delicia para los amantes del chocolate y los postres intensos.',
      img: 'https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/chocolate.png'
    },
    {
      id: 3,
      nombre: 'Panetela Especial',
      precio: 4300,
      descripcion: 'Decorada con crema batida y frutas confitadas. ¬°Puedes elegir el relleno de cada unidad!',
      img: 'https://file.garden/aEX2yhToiQk-s_Qq/Dulce%20Vida/especial%201.png'
    }
  ];
  let estadosProductos = {};
  let carrito = [];
  let ultimoTicketGenerado = "";
  let tarifas = {
    "Vedado": 300,
    "Plaza": 400,
    "Centro Habana": 400,
    "Playa": 500
  };

  document.getElementById('loader').style.display = "flex";

  function estadoAmigable(valor) {
    if (typeof valor !== "string") return valor;
    if (valor.trim().toLowerCase() === "si") return "Disponible";
    if (valor.trim().toLowerCase() === "s√≠") return "Disponible";
    if (valor.trim().toLowerCase() === "no") return "Agotado";
    if (valor.trim().toLowerCase() === "agotado") return "Agotado";
    if (valor.trim().toLowerCase() === "disponible") return "Disponible";
    return valor;
  }

  function iniciarCarga() {
    Promise.all([
      fetch("https://script.google.com/macros/s/AKfycbxcw9TD2SmgDgimOi3hmJQ7FN7SGTjZN5BIaiIBxGpLeG6_XtFDDqSflQjLoB4X4UT5/exec?func=rellenosDisponibles")
        .then(r => r.json())
        .then(data => {
          rellenosEspecial = data;
          rellenosEspecialCargados = true;
          cantidadesRellenos = Array(rellenosEspecial.length).fill(0);
        }),
      fetch("https://script.google.com/macros/s/AKfycbxcw9TD2SmgDgimOi3hmJQ7FN7SGTjZN5BIaiIBxGpLeG6_XtFDDqSflQjLoB4X4UT5/exec?func=obtenerEstadosProductos")
        .then(respuesta => respuesta.json())
        .then(data => {
          estadosProductos = data;
        })
    ]).then(() => {
      cargarProductos();
      setTimeout(() => {
        document.getElementById('loader').classList.add("oculto");
        setTimeout(() => { document.getElementById('loader').style.display = "none"; }, 400);
      }, 250);
    }).catch(() => {
      setTimeout(() => {
        document.getElementById('loader').classList.add("oculto");
        setTimeout(() => { document.getElementById('loader').style.display = "none"; }, 400);
      }, 600);
    });
  }
  iniciarCarga();

  function cargarProductos() {
    const cont = document.getElementById('productos');
    cont.innerHTML = '';
    productos.forEach(p => {
      const div = document.createElement('div');
      div.className = 'producto';
      div.setAttribute('tabindex', '0');
      div.setAttribute('aria-label', p.nombre);
      const estado = estadoAmigable(estadosProductos[p.nombre] || '');
      const agotado = estado === "Agotado";
      if (agotado) div.classList.add('agotado');

      // Panetela Especial con selector de rellenos
      if (p.nombre === 'Panetela Especial') {
        if (!rellenosEspecialCargados) {
          div.innerHTML = `
            ${estado ? `<div class="etiqueta">${estado}</div>` : ''}
            <img src="${p.img}" alt="${p.nombre}" />
            <h3>${p.nombre}</h3>
            <p>${p.descripcion}</p>
            <div style="text-align:center;padding:20px 0;">Cargando opciones de relleno...</div>
          `;
        } else {
          const hayDisponible = rellenosEspecial.some(r => r.disponible === "s√≠");
          if (!hayDisponible) {
            div.innerHTML = `
              ${estado ? `<div class="etiqueta">${estado}</div>` : ''}
              <img src="${p.img}" alt="${p.nombre}" />
              <h3>${p.nombre}</h3>
              <p>${p.descripcion}</p>
              <div style="margin:14px 0 6px 0;font-weight:bold;color:#c00;">No hay rellenos disponibles</div>
              <button disabled style="background:gray;cursor:not-allowed;">No disponible</button>
            `;
          } else {
            let rellenoControles = '';
            rellenosEspecial.forEach((r, idx) => {
              rellenoControles += `
                <div style="display:flex;align-items:center;gap:7px;margin:5px 0;">
                  <span style="flex:1;min-width:110px;font-weight:500;${r.disponible==='no'?'color:#aaa;':''}">${r.nombre}</span>
                  <button type="button" class="btn-relleno" onclick="modificarCantidadRelleno(${idx},-1)" ${r.disponible==='no'?'disabled style="background:#ddd;color:#aaa;cursor:not-allowed;"':''}>‚àí</button>
                  <span id="cantRelleno_${idx}" style="width:27px;display:inline-block;text-align:center;font-weight:bold;">${cantidadesRellenos[idx]||0}</span>
                  <button type="button" class="btn-relleno" onclick="modificarCantidadRelleno(${idx},1)" ${r.disponible==='no'?'disabled style="background:#ddd;color:#aaa;cursor:not-allowed;"':''}>+</button>
                  ${r.disponible==='no'?'<span style="color:#e00;font-size:0.88em;">Agotado</span>':''}
                </div>
              `;
            });
            div.innerHTML = `
              ${estado ? `<div class="etiqueta">${estado}</div>` : ''}
              <img src="${p.img}" alt="${p.nombre}" />
              <h3>${p.nombre}</h3>
              <p>${p.descripcion}</p>
              <div style="margin:7px 0 3px 0;font-weight:bold;">Elige los rellenos y cantidades:</div>
              <div id="rellenoControles">${rellenoControles}</div>
              <button onclick="agregarPanetelaEspecialAlCarrito()" style="margin-top:13px;">A√±adir al carrito</button>
            `;
          }
        }
      } else {
        // Otros productos
        div.innerHTML = `
          ${estado ? `<div class="etiqueta">${estado}</div>` : ''}
          <img src="${p.img}" alt="${p.nombre}" />
          <h3>${p.nombre}</h3>
          <p>${p.descripcion}</p>
          <p><strong>${p.precio} CUP</strong></p>
          <div class="control-cantidad">
            <button aria-label="Quitar uno" onclick="modificarCantidad(${p.id}, -1)" ${agotado ? 'disabled' : ''}>‚àí</button>
            <span id="cantidad-${p.id}">0</span>
            <button aria-label="Agregar uno" onclick="modificarCantidad(${p.id}, 1)" ${agotado ? 'disabled' : ''}>+</button>
          </div>
          ${agotado
            ? `<button disabled style="background: gray; cursor: not-allowed;">No disponible</button>`
            : `<button onclick="agregarAlCarritoDesdeBoton(${p.id})" aria-label="A√±adir ${p.nombre} al carrito">A√±adir al carrito</button>`}
        `;
      }
      cont.appendChild(div);
    });
    actualizarCarrito();
  }

  
  function modificarCantidad(id, delta) {
    let input = document.getElementById("cantidad-" + id);
    let cantidad = parseInt(input.textContent, 10) || 0;
    cantidad += delta;
    if (cantidad < 0) cantidad = 0;
    input.textContent = cantidad;
  }

  function agregarAlCarritoDesdeBoton(id) {
    let input = document.getElementById("cantidad-" + id);
    let cantidad = parseInt(input.textContent, 10) || 0;
    if (cantidad < 1) {
      mostrarToast('Debes seleccionar al menos una unidad.');
      return;
    }
    let producto = productos.find(p => p.id === id);
    let itemExistente = carrito.find(i => i.id === id && !i.detalleRellenos);
    if (itemExistente) {
      itemExistente.cantidad += cantidad;
    } else {
      carrito.push({
        id: producto.id,
        nombre: producto.nombre,
        precio: producto.precio,
        cantidad: cantidad
      });
    }
    input.textContent = 0;
    mostrarToast('Producto agregado al carrito');
    actualizarCarrito();
  }

  function modificarCantidadRelleno(idx, delta) {
    if (!cantidadesRellenos[idx]) cantidadesRellenos[idx] = 0;
    cantidadesRellenos[idx] += delta;
    if (cantidadesRellenos[idx] < 0) cantidadesRellenos[idx] = 0;
    document.getElementById(`cantRelleno_${idx}`).textContent = cantidadesRellenos[idx];
  }

  function agregarPanetelaEspecialAlCarrito() {
    let totalUnidades = cantidadesRellenos.reduce((a, b) => a + b, 0);
    if (totalUnidades === 0) {
      mostrarToast('Selecciona al menos una unidad de alg√∫n relleno.');
      return;
    }
    const detalleRellenos = rellenosEspecial
      .map((r, idx) => cantidadesRellenos[idx] > 0 ? `${r.nombre} x${cantidadesRellenos[idx]}` : '')
      .filter(Boolean)
      .join(', ');
    const precioUnitario = productos.find(p => p.nombre === "Panetela Especial").precio;
    carrito.push({
      id: 1000 + Math.floor(Math.random()*100000),
      nombre: "Panetela Especial",
      precio: precioUnitario,
      cantidad: totalUnidades,
      detalleRellenos: detalleRellenos
    });
    mostrarToast('Panetela Especial agregada al carrito');
    cantidadesRellenos = Array(rellenosEspecial.length).fill(0);
    cargarProductos();
    actualizarCarrito();
  }

  function actualizarCarrito() {
    const lista = document.getElementById('listaCarrito');
    const controls = document.getElementById('carritoControls');
    lista.innerHTML = '';
    let subtotal = 0;
    if (carrito.length === 0) {
      lista.innerHTML = `<li class="empty-cart">El carrito est√° vac√≠o. A√±ade productos para continuar.</li>`;
      controls.style.display = "none";
    } else {
      controls.style.display = "flex";
      carrito.forEach(item => {
        subtotal += item.precio * item.cantidad;
        let detalle = '';
        if (item.detalleRellenos) {
          detalle = `<div style="font-size:0.92em;color:#231d66;">(${item.detalleRellenos})</div>`;
        }
        const li = document.createElement('li');
        li.className = 'carrito-item';
        li.innerHTML = `
          <img src="${productos.find(p=>p.nombre===item.nombre).img}" class="carrito-img" alt="${item.nombre}">
          <span style="min-width:120px; flex:1;">${item.nombre}${detalle}</span>
          <div class="carrito-cantidad-box">
            <button class="carrito-cantidad-btn" aria-label="Disminuir" onclick="cambiarCantidadCarrito(${item.id}, -1)">‚àí</button>
            <input class="carrito-cantidad-input" type="number" min="1" value="${item.cantidad}" aria-label="Cantidad de ${item.nombre}" onchange="actualizarCantidadEnCarrito(${item.id}, this.value)">
            <button class="carrito-cantidad-btn" aria-label="Aumentar" onclick="cambiarCantidadCarrito(${item.id}, 1)">+</button>
          </div>
          <span style="min-width:80px;">${item.precio * item.cantidad} CUP</span>
          <button onclick="quitarDelCarrito(${item.id})" aria-label="Quitar ${item.nombre}">‚ùå</button>
        `;
        lista.appendChild(li);
      });
    }
    document.getElementById('totalCarrito').textContent = subtotal;
    actualizarTarifa();
    document.getElementById('contadorCarrito').textContent = carrito.reduce((acc, i) => acc + i.cantidad, 0);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    document.getElementById('totalFinalBox').textContent = (subtotal + (parseInt(document.getElementById('tarifaReparto').textContent, 10)||0)) + " CUP";
  }

  function cambiarCantidadCarrito(id, delta) {
    let item = carrito.find(i => i.id === id);
    if (!item) return;
    item.cantidad += delta;
    if (item.cantidad < 1) quitarDelCarrito(id);
    actualizarCarrito();
  }

  function actualizarCantidadEnCarrito(id, valor) {
    let item = carrito.find(i => i.id === id);
    if (!item) return;
    let v = parseInt(valor, 10);
    if (isNaN(v) || v < 1) v = 1;
    item.cantidad = v;
    actualizarCarrito();
  }

  function quitarDelCarrito(id) {
    carrito = carrito.filter(i => i.id !== id);
    actualizarCarrito();
  }

  function vaciarCarrito() {
    carrito = [];
    actualizarCarrito();
  }

  function mostrarResumenConfirmacion() {
    if (carrito.length === 0) {
      mostrarToast('El carrito est√° vac√≠o.');
      return;
    }
    if (!validarFormularioCliente()) return;
    const ticket = `PED-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
    ultimoTicketGenerado = ticket;
    const nombre = document.getElementById('nombre').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const codigoPais = document.getElementById('codigoPais').value;
    const entrega = document.getElementById('entrega').value;
    const direccion = entrega === 'si' ? document.getElementById('direccion').value.trim() : '';
    const reparto = entrega === 'si' ? document.getElementById('reparto').value : '';
    const fechaEntrega = document.getElementById('fechaEntrega').value;
    const telefonoLimpio = telefono.startsWith(codigoPais)
      ? telefono.slice(codigoPais.length)
      : telefono;
    const subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
    const envio = entrega === 'si' ? (tarifas[reparto] || 0) : 0;
    const total = subtotal + envio;
    let modal = document.createElement('div');
    modal.className = "modal-bg";
    modal.innerHTML = `
      <div class="modal-confirm">
        <h2>Confirmar pedido</h2>
        <div class="modal-section">
          <strong>Ticket:</strong> <span style="font-size:1.1em;">${ticket}</span>
        </div>
        <div class="modal-section">
          <strong>Productos:</strong>
          <ul style="list-style:none;padding:0; margin:5px 0 0 0;">
            ${carrito.map(i=>`<li style="margin-bottom:3px;">üç∞ ${i.nombre}${i.detalleRellenos?' ('+i.detalleRellenos+')':''} x${i.cantidad} = ${i.precio * i.cantidad} CUP</li>`).join("")}
          </ul>
        </div>
        <div class="modal-section">
          <strong>Reparto:</strong> ${reparto || '<span style="color:#888;">Sin reparto</span>'} ${envio>0 ? `(+${envio} CUP)` : ''}
        </div>
        <div class="modal-section">
          <strong>Cliente:</strong> ${nombre}<br>
          <strong>Tel.:</strong> +${codigoPais} ${telefonoLimpio}<br>
          ${direccion ? `<strong>Direcci√≥n:</strong> ${direccion}<br>` : ''}
          ${fechaEntrega ? `<strong>Entrega:</strong> ${new Date(fechaEntrega).toLocaleString("es-ES")}` : ''}
        </div>
        <div class="modal-section modal-total-row">
          <label>TOTAL:</label>
          <span class="modal-total-valor">${total} CUP</span>
        </div>
        <div class="modal-btns">
          <button class="btn-cancelar" onclick="document.body.removeChild(this.closest('.modal-bg'));">Cancelar</button>
          <button class="btn-confirmar" onclick="confirmarEnvioPedido()">Confirmar y enviar</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  function mostrarToast(msg) {
    let toast = document.createElement('div');
    toast.style.position = 'fixed';
    toast.style.bottom = '30px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = '#3b2eae';
    toast.style.color = '#fff';
    toast.style.padding = '12px 34px';
    toast.style.fontSize = '1.08em';
    toast.style.borderRadius = '12px';
    toast.style.boxShadow = '0 2px 10px #1116';
    toast.style.zIndex = '9000';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(()=>{ toast.style.opacity = "0"; }, 1500);
    setTimeout(()=>{ if (toast.parentNode) toast.parentNode.removeChild(toast); }, 1950);
  }

  function validarFormularioCliente() {
    const nombre = document.getElementById('nombre').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const fechaEntrega = document.getElementById('fechaEntrega').value;
    if (!nombre) { mostrarToast('Debes ingresar tu nombre.'); return false; }
    if (!telefono.match(/^[0-9]{7,15}$/)) { mostrarToast('El tel√©fono debe ser num√©rico y v√°lido.'); return false; }
    if (!fechaEntrega) { mostrarToast('Debes seleccionar la fecha de entrega.'); return false; }
    if (document.getElementById('entrega').value === 'si') {
      if (!document.getElementById('direccion').value.trim()) { mostrarToast('Debes ingresar una direcci√≥n.'); return false; }
      if (!document.getElementById('reparto').value) { mostrarToast('Debes seleccionar el reparto.'); return false; }
    }
    return true;
  }

  function actualizarTarifa() {
    let reparto = document.getElementById('reparto')?.value;
    let entrega = document.getElementById('entrega')?.value;
    let tarifa = (entrega === 'si' && reparto && tarifas[reparto]) ? tarifas[reparto] : 0;
    document.getElementById('tarifaReparto').textContent = tarifa;
    let subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
    document.getElementById('totalFinalBox').textContent = (subtotal + tarifa) + " CUP";
  }

  function mostrarDireccion() {
    let entrega = document.getElementById('entrega').value;
    document.getElementById('direccionEntrega').style.display = (entrega === "si" ? "block" : "none");
    actualizarTarifa();
  }

  function confirmarEnvioPedido() {
    enviarPedido();
    document.body.querySelector('.modal-bg')?.remove();
  }

  function enviarPedido() {
    // Datos
    const nombre = document.getElementById('nombre').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const codigoPais = document.getElementById('codigoPais').value;
    const entrega = document.getElementById('entrega').value;
    const direccion = entrega === 'si' ? document.getElementById('direccion').value.trim() : '';
    const reparto = entrega === 'si' ? document.getElementById('reparto').value : '';
    const fechaEntrega = document.getElementById('fechaEntrega').value;
    const subtotal = carrito.reduce((s, i) => s + i.precio * i.cantidad, 0);
    const envio = entrega === 'si' ? (tarifas[reparto] || 0) : 0;
    const total = subtotal + envio;
    const productosFormateados = carrito.map(i =>
      `${i.nombre}${i.detalleRellenos ? ' ('+i.detalleRellenos+')' : ''} x${i.cantidad}`
    ).join('; ');

    // Enviar a Sheets
    document.getElementById('inputNombre').value = nombre;
    document.getElementById('inputTelefono').value = telefono;
    document.getElementById('inputCodigoPais').value = codigoPais;
    document.getElementById('inputDireccion').value = direccion;
    document.getElementById('inputReparto').value = reparto;
    document.getElementById('inputProductos').value = productosFormateados;
    document.getElementById('inputSubtotal').value = subtotal;
    document.getElementById('inputEnvio').value = envio;
    document.getElementById('inputTotal').value = total;
    document.getElementById('inputEntrega').value = entrega;
    document.getElementById('inputFechaEntrega').value = fechaEntrega;
    document.getElementById('inputEstado').value = "Pendiente";
    document.getElementById('inputTicket').value = ultimoTicketGenerado;
    document.getElementById('sheetForm').submit();

    // Redactar mensaje WhatsApp
    let resumen = 'üßæ *Ticket de Compra* üßæ\n-------------------------\n';
    resumen += `N.¬∫ de ticket: ${ultimoTicketGenerado}\n`;
    carrito.forEach(i => {
      resumen += `üç∞ ${i.nombre}${i.detalleRellenos ? ' ('+i.detalleRellenos+')' : ''} x${i.cantidad} = ${i.precio * i.cantidad} CUP\n`;
    });
    resumen += `-------------------------\nSubtotal: ${subtotal} CUP\n`;
    if (envio > 0) resumen += `Env√≠o: ${envio} CUP\n`;
    resumen += `TOTAL: ${total} CUP\n-------------------------\n`;
    resumen += `Cliente: ${nombre}\nTel: +${codigoPais} ${telefono}\n`;
    if (direccion) resumen += `Direcci√≥n: ${direccion}\n`;
    if (reparto) resumen += `Reparto: ${reparto}\n`;
    if (fechaEntrega) resumen += `Entrega: ${new Date(fechaEntrega).toLocaleString("es-ES")}\n`;

    // Enviar WhatsApp
    let numeroWsp = "5358707434";
    let urlWsp = `https://wa.me/${numeroWsp}?text=${encodeURIComponent(resumen)}`;
    setTimeout(()=>{ window.open(urlWsp, '_blank'); }, 350);
    vaciarCarrito();
    mostrarToast("¬°Pedido enviado!");
  }

  function irAlCarrito() {
    document.getElementById('carrito').scrollIntoView({ behavior: "smooth" });
  }

  // Recuperar carrito de localStorage si existe
  window.addEventListener('DOMContentLoaded', function() {
    let guardado = localStorage.getItem('carrito');
    if (guardado) {
      try {
        carrito = JSON.parse(guardado);
      } catch(e){}
      actualizarCarrito();
    }
  });
</script>
<div id="carritoFlotante" onclick="irAlCarrito()" aria-label="Ver carrito" tabindex="0">
  üõí <span id="contadorCarrito">0</span>
</div>
</body>
</html>
