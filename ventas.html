<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>InventarioApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family: sans-serif; display:flex; }
    #sidebar {
      width:200px; background:#2c3e50; color:#ecf0f1; height:100vh;
      padding-top:20px; box-sizing:border-box;
    }
    #sidebar button {
      width:100%; padding:12px; border:none; background:transparent;
      color:inherit; text-align:left; cursor:pointer; outline:none;
    }
    #sidebar button:hover { background:#34495e; }
    #main { flex:1; padding:20px; overflow:auto; }
    .hidden { display:none; }
    .btn { padding:6px 12px; margin:6px 0; cursor:pointer; }
    ul { list-style:none; padding:0; }
    li { margin-bottom:8px; }
    h3 { margin-bottom: 0; margin-top: 1em; }
    label { display:block; margin-top:8px; }
    input, select { margin-bottom:8px; }
    form { margin-bottom: 12px; }
    .prod-group { border:1px solid #eee; border-radius:8px; margin-bottom:18px; padding:10px; background:#f9f9f9; }
    .prod-details { font-size: 0.95em; color: #555; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js"></script>
  <script>
    // URLs de tu proyecto
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeVSv6a5jZIllKWXwgIMk0lGrjOr4aSLBXHVnRQrb2Gqehzt0JfoLgbvzjvk2ZPHZelS89dAF9awVX/pubhtml';
    const WEB_APP = 'https://script.google.com/macros/s/AKfycbyrB4-tvPPrMI_8NcJbvnrVECwAGcElWzdXnLgkVobqcMQpBO-EAlrG9aoPk0sxk9k7iw/exec';

    let hoja;
    function initApp() {
      Tabletop.init({
        key: SHEET_URL,
        callback: data => {
          hoja = data;
          mostrarNuevaVenta();
        },
        simpleSheet: false
      });
    }
    window.addEventListener('DOMContentLoaded', initApp);

    // Helper para proveedor por ID
    function getProveedorNombre(id) {
      if (!hoja?.Proveedores) return id || '';
      const p = hoja.Proveedores.find(pr => pr.ID == id || pr.Nombre == id);
      return p ? p.Nombre : (id || '');
    }
  </script>
</head>
<body>
  <div id="sidebar">
    <button onclick="mostrarNuevaVenta()">üõí Nueva venta</button>
    <button onclick="mostrarVentas()">üìã Ventas</button>
    <button onclick="mostrarProductos()">üì¶ Productos</button>
    <button onclick="mostrarProveedores()">üë• Proveedores</button>
    <button onclick="mostrarReportes()">üìä Reportes</button>
  </div>
  <div id="main"></div>
<script>
  // ========== NUEVA VENTA ==========
  function mostrarNuevaVenta() {
    const cont = document.getElementById('main');
    cont.innerHTML = '<h2>Nueva venta</h2>' +
      '<div id="categorias"></div>' +
      '<p>Total: <span id="venta-total">0</span> CUP</p>' +
      '<button class="btn" onclick="procesarVenta()">üßæ Registrar Venta</button>';

    // Agrupar productos por categor√≠a
    const categorias = {};
    hoja.Productos.forEach(p => {
      if (!categorias[p.Categor√≠a]) categorias[p.Categor√≠a] = [];
      categorias[p.Categor√≠a].push(p);
    });

    const catDiv = cont.querySelector('#categorias');
    for (let cat in categorias) {
      const group = document.createElement('div');
      group.className = "prod-group";
      const h3 = document.createElement('h3');
      h3.textContent = cat;
      group.appendChild(h3);
      const ul = document.createElement('ul');
      categorias[cat].forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `
          <b>${p.Nombre}</b>
          <span class="prod-details">
            | Proveedor: ${getProveedorNombre(p.Proveedor)}
            | Precio: ${p.PrecioVenta} CUP
            | Existencias: ${p.Existencias}
          </span>
          <input type="number" min="0" max="${p.Existencias}" value="0"
                 style="width:50px;"
                 onchange="actualizaTotal('${p.ID}', ${p.PrecioVenta}, this.value)" />
        `;
        ul.appendChild(li);
      });
      group.appendChild(ul);
      catDiv.appendChild(group);
    }
    window.ventaItems = {};
    window.ventaTotal = 0;
  }

  function actualizaTotal(id, precio, qty) {
    qty = parseInt(qty)||0;
    const prev = window.ventaItems[id]?.subtotal||0;
    const now = precio * qty;
    window.ventaItems[id] = { id, cantidad: qty, subtotal: now };
    window.ventaTotal += now - prev;
    document.getElementById('venta-total').textContent = window.ventaTotal;
  }

  function procesarVenta() {
    const items = Object.values(window.ventaItems).filter(i=>i.cantidad>0);
    if (!items.length) return alert('Seleccione al menos 1 producto');
    fetch(WEB_APP, {
      method:'POST',
      body: JSON.stringify({ total: window.ventaTotal, items })
    })
    .then(r=>r.json())
    .then(_=>{
      alert('Venta registrada');
      initApp();
    });
  }

  // ========== VENTAS ==========
  function mostrarVentas() {
    const cont = document.getElementById('main');
    cont.innerHTML = '<h2>Ventas</h2><ul id="lv"></ul>';
    const ul = cont.querySelector('#lv');
    (hoja.Ventas||[]).forEach(v => {
      const li = document.createElement('li');
      li.textContent = `${new Date(v.Fecha).toLocaleString()} ‚Äì ${v.Total} CUP`;
      li.onclick = ()=>mostrarDetalleVenta(v.IDVenta);
      ul.appendChild(li);
    });
  }

  function mostrarDetalleVenta(idv) {
    const cont = document.getElementById('main');
    cont.innerHTML = '<h2>Detalle de venta</h2><ul id="ld"></ul>';
    const ul = cont.querySelector('#ld');
    (hoja.DetalleVentas||[])
      .filter(d=>d.IDVenta===idv)
      .forEach(d=>{
        const prod = hoja.Productos.find(p=>p.ID===d.IDProducto);
        const li = document.createElement('li');
        li.textContent = `${prod ? prod.Nombre : d.IDProducto} √ó ${d.Cantidad} = ${d.Subtotal} CUP`;
        ul.appendChild(li);
      });
  }

  // ========== PRODUCTOS ==========
  function mostrarProductos() {
    const cont = document.getElementById('main');
    cont.innerHTML = `<h2>Productos</h2>
      <button class="btn" onclick="formAgregarProd()">+ Agregar Producto</button>
      <ul id="lp"></ul>
      <div id="form-prod" class="hidden"></div>`;
    const ul = cont.querySelector('#lp');
    (hoja.Productos||[]).forEach(p=>{
      const li = document.createElement('li');
      li.innerHTML = `
        <b>${p.Nombre}</b>
        <span class="prod-details">
          | Categor√≠a: ${p.Categor√≠a}
          | Proveedor: ${getProveedorNombre(p.Proveedor)}
          | Existencias: ${p.Existencias}
          | Precio Compra: ${p.PrecioCompra} CUP
          | Precio Venta: ${p.PrecioVenta} CUP
        </span>
        <button onclick="formEditarProd('${p.ID}')">‚úèÔ∏è</button>
      `;
      ul.appendChild(li);
    });
  }

  // Formulario para agregar producto con proveedor desplegable
  function formAgregarProd() {
    const f = document.getElementById('form-prod');
    f.classList.remove('hidden');
    const proveedores = hoja.Proveedores || [];
    let provOptions = `<option value="">Seleccionar...</option>`;
    proveedores.forEach(pr => {
      provOptions += `<option value="${pr.ID}">${pr.Nombre}</option>`;
    });
    f.innerHTML = `
      <form id="agregar-prod-form" onsubmit="enviarAgregarProd(event)">
        <label>Nombre <input name="nombre" required></label>
        <label>Categor√≠a <input name="categoria" required></label>
        <label>Proveedor
          <select name="proveedor" required>${provOptions}</select>
        </label>
        <label>Cantidad <input name="cantidad" type="number" min="0" required></label>
        <label>Precio de compra <input name="precioCompra" type="number" min="0" step="any" required></label>
        <label>Precio de venta <input name="precioVenta" type="number" min="0" step="any" required></label>
        <button class="btn" type="submit">Agregar al Inventario</button>
        <button class="btn" type="button" onclick="cerrarFormProd()">Cancelar</button>
      </form>
    `;
  }

  function enviarAgregarProd(e) {
    e.preventDefault();
    const form = e.target;
    const datos = {
      action: 'addProd',
      nombre: form.nombre.value,
      categoria: form.categoria.value,
      proveedor: form.proveedor.value,
      cantidad: parseInt(form.cantidad.value)||0,
      precioCompra: parseFloat(form.precioCompra.value)||0,
      precioVenta: parseFloat(form.precioVenta.value)||0
    };
    fetch(WEB_APP, {
      method:'POST',
      body: JSON.stringify(datos)
    }).then(_=>{
      alert('Producto agregado');
      cerrarFormProd();
      initApp();
      mostrarProductos();
    });
  }

  function cerrarFormProd() {
    const f = document.getElementById('form-prod');
    f.classList.add('hidden');
    f.innerHTML = '';
  }

  // Editar producto con proveedor desplegable
  function formEditarProd(id) {
    const prod = hoja.Productos.find(p=>p.ID===id);
    const f = document.getElementById('form-prod');
    f.classList.remove('hidden');
    const proveedores = hoja.Proveedores || [];
    let provOptions = `<option value="">Seleccionar...</option>`;
    proveedores.forEach(pr => {
      provOptions += `<option value="${pr.ID}" ${prod.Proveedor == pr.ID ? "selected" : ""}>${pr.Nombre}</option>`;
    });
    f.innerHTML = `
      <form id="editar-prod-form" onsubmit="enviarEditarProd(event, '${id}')">
        <label>Nombre <input name="nombre" value="${prod.Nombre}" required></label>
        <label>Categor√≠a <input name="categoria" value="${prod.Categor√≠a}" required></label>
        <label>Proveedor
          <select name="proveedor" required>${provOptions}</select>
        </label>
        <label>Cantidad <input name="cantidad" type="number" min="0" value="${prod.Existencias}" required></label>
        <label>Precio de compra <input name="precioCompra" type="number" min="0" step="any" value="${prod.PrecioCompra}" required></label>
        <label>Precio de venta <input name="precioVenta" type="number" min="0" step="any" value="${prod.PrecioVenta}" required></label>
        <button class="btn" type="submit">Actualizar</button>
        <button class="btn" type="button" onclick="borrarProd('${id}')">Eliminar</button>
        <button class="btn" type="button" onclick="cerrarFormProd()">Salir</button>
      </form>
    `;
  }

  function enviarEditarProd(e, id) {
    e.preventDefault();
    const form = e.target;
    const datos = {
      action: 'updProd',
      id,
      nombre: form.nombre.value,
      categoria: form.categoria.value,
      proveedor: form.proveedor.value,
      cantidad: parseInt(form.cantidad.value)||0,
      precioCompra: parseFloat(form.precioCompra.value)||0,
      precioVenta: parseFloat(form.precioVenta.value)||0
    };
    fetch(WEB_APP, {
      method:'POST',
      body: JSON.stringify(datos)
    }).then(_=>{
      alert('Producto actualizado');
      cerrarFormProd();
      initApp();
      mostrarProductos();
    });
  }

  function borrarProd(id) {
    if(!confirm('Eliminar producto?')) return;
    fetch(WEB_APP, {
      method:'POST',
      body: JSON.stringify({ action:'delProd', id })
    }).then(_=>{
      alert('Producto eliminado');
      cerrarFormProd();
      initApp();
      mostrarProductos();
    });
  }

  // ========== PROVEEDORES ==========
  function mostrarProveedores() {
    const cont = document.getElementById('main');
    cont.innerHTML = '<h2>Proveedores</h2>'
      + '<button class="btn" onclick="formAgregarProv()">+ Agregar Proveedor</button>'
      + '<ul id="lpr"></ul><div id="form-pr" class="hidden"></div>';
    const ul = cont.querySelector('#lpr');
    (hoja.Proveedores||[]).forEach(pr=>{
      const li = document.createElement('li');
      li.innerHTML = `
        <b>${pr.Nombre}</b>
        <span class="prod-details">
          | Empresa: ${pr.Empresa||''}
          | Tel√©fono: ${pr.Tel√©fono||''}
          | Correo: ${pr.Correo||''}
          | Direcci√≥n: ${pr.Direcci√≥n||''}
        </span>
        <button title="Llamar" onclick="location.href='tel:${pr.Tel√©fono}'">üìû</button>
        <button title="SMS" onclick="location.href='sms:${pr.Tel√©fono}'">üí¨</button>
        <button title="Correo" onclick="location.href='mailto:${pr.Correo}'">‚úâÔ∏è</button>
      `;
      ul.appendChild(li);
    });
  }

  function formAgregarProv() {
    const f = document.getElementById('form-pr');
    f.classList.remove('hidden');
    f.innerHTML = `
      <form id="agregar-prov-form" onsubmit="enviarAgregarProv(event)">
        <label>Nombre <input name="nombre" required></label>
        <label>Empresa <input name="empresa"></label>
        <label>Tel√©fono <input name="telefono"></label>
        <label>Correo <input name="correo" type="email"></label>
        <label>Direcci√≥n <input name="direccion"></label>
        <button class="btn" type="submit">Agregar Proveedor</button>
        <button class="btn" type="button" onclick="cerrarFormProv()">Cancelar</button>
      </form>
    `;
  }

  function enviarAgregarProv(e) {
    e.preventDefault();
    const form = e.target;
    const datos = {
      action: 'addProv',
      nombre: form.nombre.value,
      empresa: form.empresa.value,
      telefono: form.telefono.value,
      correo: form.correo.value,
      direccion: form.direccion.value
    };
    fetch(WEB_APP, {
      method:'POST',
      body: JSON.stringify(datos)
    }).then(_=>{
      alert('Proveedor agregado');
      cerrarFormProv();
      initApp();
      mostrarProveedores();
    });
  }

  function cerrarFormProv() {
    const f = document.getElementById('form-pr');
    f.classList.add('hidden');
    f.innerHTML = '';
  }

  // ========== REPORTES ==========
  function mostrarReportes() {
    const hoy = new Date().toDateString();
    let ventaHoy = 0, impHoy=0, ganHoy=0;
    (hoja.Ventas||[]).forEach(v=>{
      if (new Date(v.Fecha).toDateString()===hoy) {
        impHoy += parseFloat(v.Total);
        (hoja.DetalleVentas||[])
          .filter(d=>d.IDVenta===v.IDVenta)
          .forEach(d=>{
            const prod = hoja.Productos.find(p=>p.ID===d.IDProducto);
            ganHoy += (prod.PrecioVenta - prod.PrecioCompra)*d.Cantidad;
            ventaHoy += parseInt(d.Cantidad)||0;
          });
      }
    });
    const mes = new Date().getMonth();
    let ganMes = 0;
    (hoja.Ventas||[]).forEach(v=>{
      if (new Date(v.Fecha).getMonth()===mes) {
        (hoja.DetalleVentas||[])
          .filter(d=>d.IDVenta===v.IDVenta)
          .forEach(d=>{
            const prod = hoja.Productos.find(p=>p.ID===d.IDProducto);
            ganMes += (prod.PrecioVenta - prod.PrecioCompra)*d.Cantidad;
          });
      }
    });
    document.getElementById('main').innerHTML = `
      <h2>Reportes</h2>
      <p>Ventas de Hoy: ${ventaHoy}</p>
      <p>Importe Diario: ${impHoy} CUP</p>
      <p>Ganancia Diaria: ${ganHoy} CUP</p>
      <p>Ganancia del Mes: ${ganMes} CUP</p>
    `;
  }
</script>
</body>
</html>
