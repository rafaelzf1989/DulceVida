<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>InventarioApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family: sans-serif; display:flex; }
    #sidebar {
      width:200px; background:#2c3e50; color:#ecf0f1; height:100vh;
      padding-top:20px; box-sizing:border-box; position:fixed; left:0; top:0;
      transform: translateX(-100%);
      transition: transform .3s;
      z-index: 10;
    }
    #sidebar.visible { transform: translateX(0);}
    #sidebar button {
      width:100%; padding:12px; border:none; background:transparent;
      color:inherit; text-align:left; cursor:pointer; outline:none;
    }
    #sidebar button:hover { background:#34495e; }
    #menu-toggle {
      position:fixed; left:10px; top:10px; z-index:11;
      background: #2c3e50; color:#fff; border:none; font-size:1.5em; border-radius:50%; width:40px; height:40px; cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }
    #main { flex:1; padding:20px; overflow:auto; margin-left:0; width:100vw;}
    @media (min-width: 600px) {
      #main { margin-left:0;}
      #sidebar.visible ~ #main { margin-left:200px; }
    }
    .hidden { display:none; }
    .btn { padding:6px 12px; margin:6px 0; cursor:pointer; }
    ul { list-style:none; padding:0; }
    li { margin-bottom:8px; }
    h3 { margin-bottom: 0; margin-top: 1em; }
    label { display:block; margin-top:8px; }
    input, select { margin-bottom:8px; }
    form { margin-bottom: 12px; }
    .prod-group { border:1px solid #eee; border-radius:8px; margin-bottom:18px; padding:10px; background:#f9f9f9; }
    .prod-details { font-size: 0.95em; color: #555; }
    .item-btn { margin-left: 4px; }
    .venta-resumen { font-weight: bold; margin-top: 16px; }
    .disabled { opacity: .5; pointer-events: none;}
    .flex-row {display:flex; align-items:center; gap:12px;}
    .venta-cant {margin-left:12px;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js"></script>
  <script>
    // URLs reales de tu proyecto
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeVSv6a5jZIllKWXwgIMk0lGrjOr4aSLBXHVnRQrb2Gqehzt0JfoLgbvzjvk2ZPHZelS89dAF9awVX/pubhtml';
    const WEB_APP = 'https://script.google.com/macros/s/AKfycbyrB4-tvPPrMI_8NcJbvnrVECwAGcElWzdXnLgkVobqcMQpBO-EAlrG9aoPk0sxk9k7iw/exec';

    let hoja = {};
    let productos = [];
    let proveedores = [];
    let ventas = [];
    let detalleVentas = [];

    // Sidebar toggle
    function toggleSidebar(force) {
      const sidebar = document.getElementById('sidebar');
      if(force === true) sidebar.classList.add('visible');
      else if(force === false) sidebar.classList.remove('visible');
      else sidebar.classList.toggle('visible');
    }

    // Helper para proveedor por ID
    function getProveedorNombre(id) {
      const p = proveedores.find(pr => pr.ID == id || pr.Nombre == id);
      return p ? p.Nombre : (id || '');
    }

    // Tabletop: Lee y normaliza los datos
    function cargarDatos(callback) {
      Tabletop.init({
        key: SHEET_URL,
        callback: data => {
          hoja = data;
          productos = (hoja.Productos||[]).filter(r=>r.ID && r.Nombre);
          proveedores = (hoja.Proveedores||[]).filter(r=>r.ID && r.Nombre);
          ventas = (hoja.Ventas||[]).filter(r=>r.IDVenta);
          detalleVentas = (hoja.DetalleVentas||[]).filter(r=>r.IDVenta);
          if(callback) callback();
        },
        simpleSheet: false
      });
    }

    // ========== NUEVA VENTA ==========
    function mostrarNuevaVenta() {
      document.title = "Nueva venta - InventarioApp";
      cerrarSidebarSiMovil();
      cargarDatos(function(){
        const cont = document.getElementById('main');
        cont.innerHTML = '<h2>Nueva venta</h2>' +
          '<div id="categorias"></div>' +
          '<div class="venta-resumen">Total: <span id="venta-total">0</span> CUP</div>' +
          '<button class="btn" id="btn-registrar-venta">üßæ Registrar Venta</button>';

        // Agrupar productos por categor√≠a
        const categorias = {};
        productos.forEach(p => {
          if (!categorias[p.Categor√≠a]) categorias[p.Categor√≠a] = [];
          categorias[p.Categor√≠a].push(p);
        });

        const catDiv = cont.querySelector('#categorias');
        for (let cat in categorias) {
          const group = document.createElement('div');
          group.className = "prod-group";
          const h3 = document.createElement('h3');
          h3.textContent = cat;
          group.appendChild(h3);
          const ul = document.createElement('ul');
          categorias[cat].forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `
              <b>${p.Nombre}</b>
              <span class="prod-details">
                | Proveedor: ${getProveedorNombre(p.Proveedor)}
                | Precio: ${p.PrecioVenta} CUP
                | Existencias: ${p.Existencias}
              </span>
              <input class="venta-cant" type="number" min="0" max="${p.Existencias}" value="0"
                     data-id="${p.ID}" data-precio="${p.PrecioVenta}" style="width:50px;" />
            `;
            ul.appendChild(li);
          });
          group.appendChild(ul);
          catDiv.appendChild(group);
        }
        window.ventaItems = {};
        window.ventaTotal = 0;

        // Escucha cambios en los inputs para el c√°lculo de venta
        document.querySelectorAll('.venta-cant').forEach(inp => {
          inp.addEventListener('input', function() {
            const id = this.dataset.id, precio = Number(this.dataset.precio), qty = parseInt(this.value)||0;
            const prev = window.ventaItems[id]?.subtotal||0;
            const now = precio * qty;
            window.ventaItems[id] = { id, cantidad: qty, subtotal: now };
            window.ventaTotal += now - prev;
            calcularTotalVenta();
          });
        });

        document.getElementById('btn-registrar-venta').addEventListener('click', procesarVenta);
      });
    }
    function calcularTotalVenta() {
      let total = 0;
      for (const k in window.ventaItems) if(window.ventaItems[k].cantidad>0) total += window.ventaItems[k].subtotal;
      window.ventaTotal = total;
      document.getElementById('venta-total').textContent = total;
    }
    function procesarVenta() {
      const items = Object.values(window.ventaItems).filter(i=>i.cantidad>0);
      if (!items.length) return alert('Seleccione al menos 1 producto');
      fetch(WEB_APP, {
        method:'POST',
        body: JSON.stringify({ total: window.ventaTotal, items })
      })
      .then(r=>r.json())
      .then(_=>{
        alert('Venta registrada');
        mostrarNuevaVenta();
      });
    }

    // ========== VENTAS ==========
    function mostrarVentas() {
      document.title = "Ventas - InventarioApp";
      cerrarSidebarSiMovil();
      cargarDatos(function(){
        const cont = document.getElementById('main');
        cont.innerHTML = '<h2>Ventas</h2><ul id="lv"></ul>';
        const ul = cont.querySelector('#lv');
        ventas.forEach(v => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${new Date(v.Fecha).toLocaleString()} ‚Äì ${v.Total} CUP</span>
            <button class="item-btn" onclick="mostrarDetalleVenta('${v.IDVenta}')">üîç Detalles</button>
          `;
          ul.appendChild(li);
        });
      });
    }
    function mostrarDetalleVenta(idv) {
      document.title = "Detalle de Venta - InventarioApp";
      cerrarSidebarSiMovil();
      cargarDatos(function(){
        const cont = document.getElementById('main');
        cont.innerHTML = '<h2>Detalle de venta</h2><ul id="ld"></ul><button class="btn" id="btn-volver-ventas">Volver</button>';
        const ul = cont.querySelector('#ld');
        detalleVentas
          .filter(d=>d.IDVenta===idv)
          .forEach(d=>{
            const prod = productos.find(p=>p.ID===d.IDProducto);
            const li = document.createElement('li');
            li.innerHTML = `
              <b>${prod ? prod.Nombre : d.IDProducto}</b>
              <span class='prod-details'>| Cantidad: ${d.Cantidad} | Total: ${d.Subtotal} CUP</span>
            `;
            ul.appendChild(li);
          });
        document.getElementById('btn-volver-ventas').onclick = mostrarVentas;
      });
    }

    // ========== PRODUCTOS ==========
    function mostrarProductos() {
      document.title = "Productos - InventarioApp";
      cerrarSidebarSiMovil();
      cargarDatos(function(){
        const cont = document.getElementById('main');
        cont.innerHTML = `<h2>Productos</h2>
          <button class="btn" id="btn-agregar-prod">+ Agregar Producto</button>
          <ul id="lp"></ul>
          <div id="form-prod" class="hidden"></div>`;
        const ul = cont.querySelector('#lp');
        productos.forEach(p=>{
          const li = document.createElement('li');
          li.innerHTML = `
            <b>${p.Nombre}</b>
            <span class="prod-details">
              | Categor√≠a: ${p.Categor√≠a}
              | Proveedor: ${getProveedorNombre(p.Proveedor)}
              | Existencias: ${p.Existencias}
              | Precio Compra: ${p.PrecioCompra} CUP
              | Precio Venta: ${p.PrecioVenta} CUP
            </span>
            <button class="item-btn" onclick="formEditarProd('${p.ID}')">‚úèÔ∏è</button>
          `;
          ul.appendChild(li);
        });
        document.getElementById('btn-agregar-prod').addEventListener('click', formAgregarProd);
      });
    }
    // Formulario para agregar producto con proveedor desplegable
    function formAgregarProd() {
      const f = document.getElementById('form-prod');
      f.classList.remove('hidden');
      let provOptions = `<option value="">Seleccionar...</option>`;
      proveedores.forEach(pr => {
        provOptions += `<option value="${pr.ID}">${pr.Nombre}</option>`;
      });
      f.innerHTML = `
        <form id="agregar-prod-form">
          <label>Nombre <input name="nombre" required></label>
          <label>Categor√≠a <input name="categoria" required></label>
          <label>Proveedor
            <select name="proveedor" required>${provOptions}</select>
          </label>
          <label>Cantidad <input name="cantidad" type="number" min="0" required></label>
          <label>Precio de compra <input name="precioCompra" type="number" min="0" step="any" required></label>
          <label>Precio de venta <input name="precioVenta" type="number" min="0" step="any" required></label>
          <button class="btn" type="submit">Agregar al Inventario</button>
          <button class="btn" type="button" id="btn-cerrar-prod">Cancelar</button>
        </form>
      `;
      document.getElementById('agregar-prod-form').addEventListener('submit', enviarAgregarProd);
      document.getElementById('btn-cerrar-prod').addEventListener('click', cerrarFormProd);
    }
    function enviarAgregarProd(e) {
      e.preventDefault();
      const form = e.target;
      const datos = {
        action: 'addProd',
        nombre: form.nombre.value,
        categoria: form.categoria.value,
        proveedor: form.proveedor.value,
        cantidad: parseInt(form.cantidad.value)||0,
        precioCompra: parseFloat(form.precioCompra.value)||0,
        precioVenta: parseFloat(form.precioVenta.value)||0
      };
      fetch(WEB_APP, {
        method:'POST',
        body: JSON.stringify(datos)
      }).then(_=>{
        alert('Producto agregado');
        cerrarFormProd();
        mostrarProductos();
      });
    }
    function cerrarFormProd() {
      const f = document.getElementById('form-prod');
      f.classList.add('hidden');
      f.innerHTML = '';
    }
    // Editar producto con proveedor desplegable
    function formEditarProd(id) {
      const prod = productos.find(p=>p.ID===id);
      const f = document.getElementById('form-prod');
      f.classList.remove('hidden');
      let provOptions = `<option value="">Seleccionar...</option>`;
      proveedores.forEach(pr => {
        provOptions += `<option value="${pr.ID}" ${prod.Proveedor == pr.ID ? "selected" : ""}>${pr.Nombre}</option>`;
      });
      f.innerHTML = `
        <form id="editar-prod-form">
          <label>Nombre <input name="nombre" value="${prod.Nombre}" required></label>
          <label>Categor√≠a <input name="categoria" value="${prod.Categor√≠a}" required></label>
          <label>Proveedor
            <select name="proveedor" required>${provOptions}</select>
          </label>
          <label>Cantidad <input name="cantidad" type="number" min="0" value="${prod.Existencias}" required></label>
          <label>Precio de compra <input name="precioCompra" type="number" min="0" step="any" value="${prod.PrecioCompra}" required></label>
          <label>Precio de venta <input name="precioVenta" type="number" min="0" step="any" value="${prod.PrecioVenta}" required></label>
          <button class="btn" type="submit">Actualizar</button>
          <button class="btn" type="button" id="btn-eliminar-prod">Eliminar</button>
          <button class="btn" type="button" id="btn-salir-prod">Salir</button>
        </form>
      `;
      document.getElementById('editar-prod-form').addEventListener('submit', function(e){ enviarEditarProd(e,id); });
      document.getElementById('btn-eliminar-prod').addEventListener('click', function(){ borrarProd(id); });
      document.getElementById('btn-salir-prod').addEventListener('click', cerrarFormProd);
    }
    function enviarEditarProd(e, id) {
      e.preventDefault();
      const form = e.target;
      const datos = {
        action: 'updProd',
        id,
        nombre: form.nombre.value,
        categoria: form.categoria.value,
        proveedor: form.proveedor.value,
        cantidad: parseInt(form.cantidad.value)||0,
        precioCompra: parseFloat(form.precioCompra.value)||0,
        precioVenta: parseFloat(form.precioVenta.value)||0
      };
      fetch(WEB_APP, {
        method:'POST',
        body: JSON.stringify(datos)
      }).then(_=>{
        alert('Producto actualizado');
        cerrarFormProd();
        mostrarProductos();
      });
    }
    function borrarProd(id) {
      if(!confirm('Eliminar producto?')) return;
      fetch(WEB_APP, {
        method:'POST',
        body: JSON.stringify({ action:'delProd', id })
      }).then(_=>{
        alert('Producto eliminado');
        cerrarFormProd();
        mostrarProductos();
      });
    }

    // ========== PROVEEDORES ==========
    function mostrarProveedores() {
      document.title = "Proveedores - InventarioApp";
      cerrarSidebarSiMovil();
      cargarDatos(function(){
        const cont = document.getElementById('main');
        cont.innerHTML = '<h2>Proveedores</h2>'
          + '<button class="btn" id="btn-agregar-prov">+ Agregar Proveedor</button>'
          + '<ul id="lpr"></ul><div id="form-pr" class="hidden"></div>';
        const ul = cont.querySelector('#lpr');
        proveedores.forEach(pr=>{
          const li = document.createElement('li');
          li.innerHTML = `
            <b>${pr.Nombre}</b>
            <span class="prod-details">
              ${pr.Empresa ? "| Empresa: " + pr.Empresa : ""}
              ${pr.Tel√©fono ? "| Tel√©fono: " + pr.Tel√©fono : ""}
              ${pr.Correo ? "| Correo: " + pr.Correo : ""}
              ${pr.Direcci√≥n ? "| Direcci√≥n: " + pr.Direcci√≥n : ""}
            </span>
            <button title="Llamar" onclick="location.href='tel:${pr.Tel√©fono}'">üìû</button>
            <button title="SMS" onclick="location.href='sms:${pr.Tel√©fono}'">üí¨</button>
            <button title="Correo" onclick="location.href='mailto:${pr.Correo}'">‚úâÔ∏è</button>
          `;
          ul.appendChild(li);
        });
        document.getElementById('btn-agregar-prov').addEventListener('click', formAgregarProv);
      });
    }
    function formAgregarProv() {
      const f = document.getElementById('form-pr');
      f.classList.remove('hidden');
      f.innerHTML = `
        <form id="agregar-prov-form">
          <label>Nombre <input name="nombre" required></label>
          <label>Empresa <input name="empresa"></label>
          <label>Tel√©fono <input name="telefono"></label>
          <label>Correo <input name="correo" type="email"></label>
          <label>Direcci√≥n <input name="direccion"></label>
          <button class="btn" type="submit">Agregar Proveedor</button>
          <button class="btn" type="button" id="btn-cerrar-prov">Cancelar</button>
        </form>
      `;
      document.getElementById('agregar-prov-form').addEventListener('submit', enviarAgregarProv);
      document.getElementById('btn-cerrar-prov').addEventListener('click', cerrarFormProv);
    }
    function enviarAgregarProv(e) {
      e.preventDefault();
      const form = e.target;
      const datos = {
        action: 'addProv',
        nombre: form.nombre.value,
        empresa: form.empresa.value,
        telefono: form.telefono.value,
        correo: form.correo.value,
        direccion: form.direccion.value
      };
      fetch(WEB_APP, {
        method:'POST',
        body: JSON.stringify(datos)
      }).then(_=>{
        alert('Proveedor agregado');
        cerrarFormProv();
        mostrarProveedores();
      });
    }
    function cerrarFormProv() {
      const f = document.getElementById('form-pr');
      f.classList.add('hidden');
      f.innerHTML = '';
    }

    // ========== REPORTES ==========
    function mostrarReportes() {
      document.title = "Reportes - InventarioApp";
      cerrarSidebarSiMovil();
      cargarDatos(function(){
        const hoy = new Date().toDateString();
        let ventaHoy = 0, impHoy=0, ganHoy=0;
        ventas.forEach(v=>{
          if (new Date(v.Fecha).toDateString()===hoy) {
            impHoy += parseFloat(v.Total);
            detalleVentas
              .filter(d=>d.IDVenta===v.IDVenta)
              .forEach(d=>{
                const prod = productos.find(p=>p.ID===d.IDProducto);
                ganHoy += (prod.PrecioVenta - prod.PrecioCompra)*d.Cantidad;
                ventaHoy += parseInt(d.Cantidad)||0;
              });
          }
        });
        const mes = new Date().getMonth();
        let ganMes = 0;
        ventas.forEach(v=>{
          if (new Date(v.Fecha).getMonth()===mes) {
            detalleVentas
              .filter(d=>d.IDVenta===v.IDVenta)
              .forEach(d=>{
                const prod = productos.find(p=>p.ID===d.IDProducto);
                ganMes += (prod.PrecioVenta - prod.PrecioCompra)*d.Cantidad;
              });
          }
        });
        document.getElementById('main').innerHTML = `
          <h2>Reportes</h2>
          <p>Ventas de Hoy: ${ventaHoy}</p>
          <p>Importe Diario: ${impHoy} CUP</p>
          <p>Ganancia Diaria: ${ganHoy} CUP</p>
          <p>Ganancia del Mes: ${ganMes} CUP</p>
        `;
      });
    }

    // ========== SIDEBAR Y NAVEGACI√ìN ==========
    function cerrarSidebarSiMovil() {
      if(window.innerWidth<800) toggleSidebar(false);
    }
    window.mostrarNuevaVenta = mostrarNuevaVenta;
    window.mostrarVentas = mostrarVentas;
    window.mostrarProductos = mostrarProductos;
    window.mostrarProveedores = mostrarProveedores;
    window.mostrarReportes = mostrarReportes;
    window.formAgregarProd = formAgregarProd;
    window.enviarAgregarProd = enviarAgregarProd;
    window.cerrarFormProd = cerrarFormProd;
    window.formEditarProd = formEditarProd;
    window.enviarEditarProd = enviarEditarProd;
    window.borrarProd = borrarProd;
    window.formAgregarProv = formAgregarProv;
    window.enviarAgregarProv = enviarAgregarProv;
    window.cerrarFormProv = cerrarFormProv;
    window.mostrarDetalleVenta = mostrarDetalleVenta;

    // ========== INICIO ==========
    window.addEventListener('DOMContentLoaded', function(){
      // Sidebar oculto al inicio y abre "Nueva Venta"
      document.getElementById('sidebar').classList.remove('visible');
      cargarDatos(mostrarNuevaVenta);
    });
  </script>
</head>
<body>
  <button id="menu-toggle" onclick="toggleSidebar()">
    ‚ò∞
  </button>
  <div id="sidebar">
    <button onclick="toggleSidebar(false)" style="text-align:right;font-size:1.2em;">‚úñ</button>
    <button onclick="mostrarNuevaVenta();toggleSidebar(false)">üõí Nueva venta</button>
    <button onclick="mostrarVentas();toggleSidebar(false)">üìã Ventas</button>
    <button onclick="mostrarProductos();toggleSidebar(false)">üì¶ Productos</button>
    <button onclick="mostrarProveedores();toggleSidebar(false)">üë• Proveedores</button>
    <button onclick="mostrarReportes();toggleSidebar(false)">üìä Reportes</button>
  </div>
  <div id="main"></div>
</body>
</html>
